<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI-Assisted SLR Screener (Robust)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PDF.js for client-side PDF parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <!-- Use Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .scroll-container {
            max-height: 70vh;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            background-color: white;
            padding: 1rem;
        }
        .article-card {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            transition: transform 0.2s;
        }
        .article-card:hover {
            transform: translateY(-2px);
        }
        /* Custom styling for the report output */
        #slr-draft-output {
            white-space: pre-wrap;
            font-family: 'Inter', sans-serif; 
            text-align: left;
        }
        /* Style for Markdown headings converted to HTML */
        #slr-draft-output h1, #slr-draft-output h2, #slr-draft-output h3 {
            font-weight: bold;
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
            border-bottom: 1px solid #ddd;
        }
        #slr-draft-output h1 { font-size: 2rem; }
        #slr-draft-output h2 { font-size: 1.5rem; }
        #slr-draft-output h3 { font-size: 1.25rem; }

        /* --- Styles for Document Uploader --- */
        .file-upload-label {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .file-upload-label:hover {
            box-shadow: 0 4px 15px -3px rgba(59, 130, 246, 0.5); /* blue-500 shadow */
            transform: translateY(-1px);
        }
        /* Custom scrollbar for better visual on preview area */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1; /* slate-300 */
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; /* slate-400 */
        }
    </style>
</head>
<body>
    <div class="max-w-6xl mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-8 p-6 bg-white rounded-xl shadow-lg">
            <h1 class="text-4xl font-extrabold text-blue-800">AI-Assisted SLR Screener</h1>
            <p class="text-lg text-gray-600 mt-2">Automate initial article screening using PubMed and Gemini.</p>
        </header>

        <!-- Search Form & Criteria Panel (Step 1) -->
        <div id="input-panel" class="bg-white p-6 rounded-xl shadow-lg mb-8">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">1. Define Research Question & Date Range</h2>
            <form id="criteria-form">
                <div class="mb-6">
                    <label for="research-question" class="block text-sm font-medium text-gray-700 mb-1">Enter your Research Question or PICO Structure:</label>
                    <textarea id="research-question" rows="4" required
                              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150"
                              placeholder="Example: do egfr inhibitors improve survival time in nsclc??">do egfr inhibitors improve survival time in nsclc?</textarea>
                </div>
                <div class="mb-6">
                    <label for="date-limit" class="block text-sm font-medium text-gray-700 mb-1">Date Limit (Optional): Only include articles published *since* this year (e.g., 2023)</label>
                    <input type="number" id="date-limit" min="1900" max="2099" 
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150"
                           placeholder="Leave empty for no date limit">
                </div>
                <button type="submit" id="generate-button"
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 focus:outline-none focus:ring-4 focus:ring-blue-300">
                    Generate Criteria & PubMed Query
                </button>
            </form>
        </div>
        
        <!-- System Messages & Loading Indicator -->
        <div id="status-message" class="text-center text-lg font-medium py-4 rounded-lg shadow-inner hidden"></div>


        <!-- Criteria Review and Screening Panel (Step 2) -->
        <div id="review-panel" class="bg-white p-6 rounded-xl shadow-lg mb-8 hidden">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">2. Review & Refine Criteria</h2>
            
            <!-- PICO Analysis Display -->
            <div id="pico-container" class="mb-6 p-4 bg-blue-50 rounded-lg border border-blue-200 hidden">
                <h3 class="text-lg font-semibold text-blue-900 mb-3 flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                    AI-Generated PICO Analysis
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                    <div class="bg-white p-3 rounded shadow-sm border-l-4 border-blue-500">
                        <span class="block font-bold text-gray-500 text-xs uppercase tracking-wider">Population (P)</span>
                        <span id="pico-p" class="text-gray-800 font-medium">Loading...</span>
                    </div>
                    <div class="bg-white p-3 rounded shadow-sm border-l-4 border-green-500">
                        <span class="block font-bold text-gray-500 text-xs uppercase tracking-wider">Intervention (I)</span>
                        <span id="pico-i" class="text-gray-800 font-medium">Loading...</span>
                    </div>
                    <div class="bg-white p-3 rounded shadow-sm border-l-4 border-orange-500">
                        <span class="block font-bold text-gray-500 text-xs uppercase tracking-wider">Comparison (C)</span>
                        <span id="pico-c" class="text-gray-800 font-medium">Loading...</span>
                    </div>
                    <div class="bg-white p-3 rounded shadow-sm border-l-4 border-purple-500">
                        <span class="block font-bold text-gray-500 text-xs uppercase tracking-wider">Outcome (O)</span>
                        <span id="pico-o" class="text-gray-800 font-medium">Loading...</span>
                    </div>
                </div>
            </div>

            <form id="screening-form">
                <div class="mb-4">
                    <label for="pubmed-query" class="block text-sm font-medium text-gray-700 mb-1">Suggested PubMed Query (Edit if needed)</label>
                    <input type="text" id="pubmed-query" required
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                </div>

                <div class="mb-6">
                    <label for="inclusion-criteria" class="block text-sm font-medium text-gray-700 mb-1">Inclusion/Exclusion Criteria (Edit if needed - JSON Format)</label>
                    <textarea id="inclusion-criteria" rows="6" required
                              class="w-full p-3 border border-gray-300 rounded-lg font-mono text-sm focus:ring-blue-500 focus:border-blue-500 transition duration-150">
<!-- Generated content goes here -->
</textarea>
                </div>
                
                <button type="submit" id="start-screening-button"
                        class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 focus:outline-none focus:ring-4 focus:ring-green-300">
                    Start AI Abstract Screening (Fetch Articles)
                </button>
            </form>
        </div>


        <!-- Results Panel (Step 3) -->
        <div id="results-panel" class="hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b-4 border-blue-200 pb-2">3. Abstract Screening Results</h2>
            
            <!-- LLM Included List -->
            <div class="mb-8">
                <h3 class="text-2xl font-semibold text-green-700 mb-3 flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    Included by Abstract (<span id="included-count">0</span>)
                </h3>
                <p class="text-gray-500 mb-3">These articles meet your criteria and are ready for full text review or data extraction.</p>
                <div id="included-list" class="scroll-container grid gap-4 grid-cols-1 md:grid-cols-2">
                    <!-- Articles go here -->
                </div>
            </div>

            <!-- LLM Excluded (Needs Review) List -->
            <div>
                <h3 class="text-2xl font-semibold text-red-600 mb-3 flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    Excluded by Abstract (Review Required) (<span id="excluded-count">0</span>)
                </h3>
                <p class="text-gray-500 mb-3">Review these to see if the AI was wrong and use the 'Override' button if needed.</p>
                <div id="excluded-list" class="scroll-container grid gap-4 grid-cols-1 md:grid-cols-2">
                    <!-- Articles go here -->
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-8">
                 <button onclick="window.exportResults('json')" 
                        class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 focus:outline-none focus:ring-4 focus:ring-indigo-300">
                        Export Results (JSON)
                </button>
                <button onclick="window.exportResults('csv')" 
                        class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 focus:outline-none focus:ring-4 focus:ring-emerald-300">
                        Export Results (Excel/CSV)
                </button>
            </div>
        </div>
        
        <!-- Document Upload Panel (Step 4) -->
        <div id="upload-panel" class="bg-white p-6 rounded-xl shadow-lg mt-8 hidden">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">4. Full Text Retrieval Status & Upload</h2>
            <p class="text-gray-500 mb-4">The system has attempted to automatically retrieve full text for open-access articles. Please **manually upload** any remaining paywalled articles corresponding to your included PMIDs.</p>
            
            <div id="retrieval-status-message" class="mb-4 p-3 rounded-lg bg-yellow-50 text-yellow-800 font-medium hidden"></div>

            <div class="border-2 border-dashed border-purple-200 p-6 rounded-xl bg-purple-50">
                <input type="file" id="fileInput" accept=".txt,.md,.log,.csv,.pdf" multiple class="hidden" onchange="window.handleFileSelect()">

                <label for="fileInput" class="file-upload-label flex flex-col items-center justify-center p-8 border-4 border-purple-500 rounded-lg bg-purple-100 text-purple-700 hover:bg-purple-200 transition-colors duration-200">
                    <svg class="w-12 h-12 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.884-7.904A5 5 0 0115 5a4 4 0 01.442 7.91l-1.074.214a1 1 0 00-.773.96l-.001 1.054a1 1 0 00.773.96l2.149.429a1 1 0 01.773.96v1.054a1 1 0 00.773.96l-1.074.214A4 4 0 0117 21a4 4 0 01-4-4v-1.054a1 1 0 00-.773-.96l-2.149-.429a1 1 0 01-.773-.96v-1.054a1 1 0 00-.773-.96l-1.074-.214A4 4 0 017 16z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 17v-8m0 0l-3 3m3-3l3 3"></path>
                    </svg>
                    <span class="text-lg font-semibold">Click here to upload files (PMID in filename)</span>
                    <span class="text-sm font-medium text-purple-600 mt-1">(Supports .txt, .md, .log, .csv, .pdf)</span>
                </label>
            </div>
            
            <div class="flex flex-col md:flex-row gap-4 mt-4">
                 <button id="start-full-text-review-button" onclick="window.startFullTextReview()"
                    class="hidden flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 focus:outline-none focus:ring-4 focus:ring-red-300">
                    Start LLM Full Text Inclusion Review
                </button>
                
                <button id="skip-full-text-button" onclick="window.skipFullTextReview()"
                        class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 focus:outline-none focus:ring-4 focus:ring-gray-300">
                    Skip Full Text Review & Generate Report (Use Abstracts Only)
                </button>
            </div>
            
            <!-- Document Preview Area -->
            <div id="fileListContainer" class="mt-4 space-y-4">
                <p id="initialMessage" class="text-center text-gray-500 italic p-3">Uploaded or automatically retrieved documents will appear here.</p>
            </div>
        </div>
        
        <!-- Full Text Review Panel (Step 5) -->
        <div id="full-text-review-panel" class="bg-white p-6 rounded-xl shadow-lg mt-8 hidden">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">5. Full Text Review Results & Extraction</h2>
            <p class="text-gray-600 mb-4 text-sm">The system has reviewed full texts and extracted key data points.</p>
            <div id="final-review-list" class="scroll-container grid gap-4 grid-cols-1 md:grid-cols-2">
                <p class="text-center text-gray-500 italic">No full text review has been run yet.</p>
            </div>
        </div>

        
        <!-- SLR Report Generation Panel (Step 6) -->
        <div id="report-panel" class="bg-white p-6 rounded-xl shadow-lg mt-8 hidden">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">6. Generate Systematic Review Draft</h2>
            
            <div class="mb-6">
                <label for="drafting-instructions" class="block text-sm font-medium text-gray-700 mb-1">Drafting Instructions (Optional): Tell the AI what kind of report to write.</label>
                <textarea id="drafting-instructions" rows="2" 
                          class="w-full p-3 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500 transition duration-150"
                          placeholder="e.g., Summarize key findings in a non-technical way, suitable for a general audience."></textarea>
            </div>
            
            <button id="generate-report-button"
                    class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 focus:outline-none focus:ring-4 focus:ring-purple-300">
                Generate Draft SLR
            </button>
            
            <div id="slr-draft-output" class="mt-6 p-4 border border-gray-200 rounded-lg bg-gray-50 max-h-[50vh] overflow-y-auto">
                <!-- LLM generated report will appear here -->
            </div>
        </div>
        
        <!-- SLR Draft Modification Panel (Step 7) -->
        <div id="modification-panel" class="bg-white p-6 rounded-xl shadow-lg mt-8 hidden">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">7. Modify & Refine Draft</h2>
            <div class="mb-6">
                <label for="modification-request" class="block text-sm font-medium text-gray-700 mb-1">Modification Request:</label>
                <textarea id="modification-request" rows="3" 
                          class="w-full p-3 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500 transition duration-150"
                          placeholder="e.g., Expand the conclusion to include future research directions, or change the tone to be more critical."></textarea>
            </div>
            <button id="refine-report-button"
                    class="w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 focus:outline-none focus:ring-4 focus:ring-orange-300">
                Refine Draft
            </button>
        </div>
        
        <!-- PRISMA Diagram Panel (Step 8) -->
        <div id="prisma-panel" class="bg-white p-6 rounded-xl shadow-lg mt-8 hidden">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">8. Generate PRISMA Flow Diagram</h2>
            
            <button id="generate-prisma-button" onclick="window.generatePrismaDiagram()"
                    class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 focus:outline-none focus:ring-4 focus:ring-gray-300">
                Generate PRISMA Diagram
            </button>
            
            <div id="prisma-output" class="mt-6 p-4 rounded-lg bg-white overflow-x-auto text-center">
                <!-- SVG diagram will appear here -->
                <p class="text-gray-500 italic">Click the button above to visualize the flow of the review.</p>
            </div>
        </div>

    </div>

    <!-- JavaScript Logic -->
    <script type="module">
        // Global variables for Canvas environment
        const apiKey = "AIzaSyDpqUR_N4g_lHf1zAW53st7iTWpDQlkXsM";
        const LLM_MODEL = "gemini-2.5-flash-preview-09-2025";
        const PUBMED_BASE_URL = 'https://eutils.ncbi.nlm.nih.gov/entrez/eutils/';
        // API Politeness Parameters
        const API_TOOL = "slr_screener_bot";
        const API_EMAIL = "example@example.com";

        // Set up PDF.js Worker
        if (window.pdfjsLib) {
            window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        }

        // Application State
        const appState = {
            articles: [], // Array to hold all processed articles
            criteria: {},
            pubmedQuery: '',
            dateLimit: null,
            currentDraft: '',
            uploadedTexts: {} // Stores { filename: content, ... } for both manual and auto-retrieved
        };

        // --- Utility Functions ---

        // HTML for the loading spinner
        const SPINNER_HTML = `<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-current" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`;
        
        /**
         * Toggles the loading state of a specific button.
         */
        function setButtonLoading(buttonId, isLoading) {
            const button = document.getElementById(buttonId);
            if (!button) return;

            const originalText = button.getAttribute('data-original-text');
            
            if (isLoading) {
                if (!originalText) button.setAttribute('data-original-text', button.textContent.trim());
                button.disabled = true;
                button.innerHTML = `<span class="flex items-center justify-center text-white">${SPINNER_HTML.replace('text-current', 'text-white')} Working...</span>`;
            } else {
                button.disabled = false;
                button.innerHTML = originalText || 'Start';
                button.removeAttribute('data-original-text');
            }
        }

        /**
         * Generic fetch wrapper with exponential backoff for API robustness.
         */
        async function fetchWithRetry(url, options = {}, retries = 3) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        if (response.status === 429 && i < retries - 1) { // Rate limit
                            const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                            await new Promise(resolve => setTimeout(resolve, delay));
                            continue;
                        }
                        throw new Error(`API Error: ${response.status} ${response.statusText}`);
                    }
                    return response;
                } catch (error) {
                    if (i === retries - 1) {
                        console.error("Fetch failed after all retries:", error);
                        throw error;
                    }
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        /**
         * Helper to update the status message box with process feedback.
         */
        function updateStatus(message, type = 'info') {
            const statusEl = document.getElementById('status-message');
            
            const isProcessing = type === 'process' || message.includes('Working');

            statusEl.innerHTML = isProcessing ? `<span class="flex items-center justify-center">${SPINNER_HTML} ${message}</span>` : message;
            
            statusEl.className = 'text-center text-lg font-medium py-4 rounded-xl shadow-md mt-4';
            statusEl.classList.remove('hidden', 'bg-red-100', 'text-red-800', 'bg-green-100', 'text-green-800', 'bg-yellow-100', 'text-yellow-800', 'bg-blue-100', 'text-blue-800', 'flex', 'items-center', 'justify-center');

            if (type === 'error') {
                statusEl.classList.add('bg-red-100', 'text-red-800');
            } else if (type === 'success') {
                statusEl.classList.add('bg-green-100', 'text-green-800');
            } else if (isProcessing) {
                statusEl.classList.add('bg-blue-100', 'text-blue-800');
            } else { // info
                statusEl.classList.add('bg-yellow-100', 'text-yellow-800');
            }
            statusEl.classList.remove('hidden');
        }

        // --- Utility: Concurrency Limiter ---
        async function runWithConcurrency(tasks, limit) {
            const results = [];
            const executing = [];
            for (const task of tasks) {
                const p = Promise.resolve().then(() => task());
                results.push(p);
                const e = p.then(() => executing.splice(executing.indexOf(e), 1));
                executing.push(e);
                if (executing.length >= limit) {
                    await Promise.race(executing);
                }
            }
            return Promise.all(results);
        }

        // --- LLM Full Text Review Function (Enhanced for Extraction) ---
        
        async function reviewFullText(article, criteria, fullText) {
            // Truncate full text to prevent exceeding context window
            const truncatedText = fullText.substring(0, 8000); 

            const systemPrompt = `You are a systematic review expert performing a final full-text screening. Analyze the provided FULL TEXT against the strict Inclusion/Exclusion criteria. 
            
            Your output MUST be a single JSON object with 4 fields:
            1. "FinalDecision": 'FINAL_INCLUDE' or 'FINAL_EXCLUDE'.
            2. "FinalReasoning": A concise justification.
            3. "StudyDesign": (e.g., RCT, Cohort, Case Study, Review).
            4. "SamplePopulation": (e.g., N=50 medical students, 120 patients). extract specific numbers if available.
            5. "KeyFindings": A 1-sentence summary of the main outcome relevant to the research question.`;

            const userQuery = `
                Article PMID: ${article.PMID}
                Research Question: ${document.getElementById('research-question').value.trim()}
                
                CRITERIA: 
                Inclusion: ${criteria.Inclusion}
                Exclusion: ${criteria.Exclusion}

                FULL TEXT (Excerpt):
                ---
                ${truncatedText}
                ---
                
                Extract data and make a decision based ONLY on the text provided.
            `;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "FinalDecision": { "type": "STRING", "enum": ["FINAL_INCLUDE", "FINAL_EXCLUDE"] },
                            "FinalReasoning": { "type": "STRING" },
                            "StudyDesign": { "type": "STRING" },
                            "SamplePopulation": { "type": "STRING" },
                            "KeyFindings": { "type": "STRING" }
                        }
                    }
                }
            };
            
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${LLM_MODEL}:generateContent?key=${apiKey}`;

            try {
                const response = await fetchWithRetry(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (jsonText) {
                    const llmResult = JSON.parse(jsonText);
                    return {
                        FinalDecision: llmResult.FinalDecision,
                        FinalReasoning: llmResult.FinalReasoning,
                        StudyDesign: llmResult.StudyDesign || "Not specified",
                        SamplePopulation: llmResult.SamplePopulation || "Not specified",
                        KeyFindings: llmResult.KeyFindings || "Not specified"
                    };
                } else {
                    throw new Error("LLM returned an empty or unparsable response.");
                }
            } catch (error) {
                console.error("LLM full text review error for PMID", article.PMID, error);
                return {
                    FinalDecision: 'ERROR',
                    FinalReasoning: 'LLM failed to process full text.',
                };
            }
        }
        
        /**
         * Step 5: Initiates the Full Text Review process.
         */
        window.startFullTextReview = async () => {
            setButtonLoading('start-full-text-review-button', true);
            document.getElementById('full-text-review-panel').classList.remove('hidden');
            document.getElementById('final-review-list').innerHTML = `<p class="text-center text-gray-500 italic flex items-center justify-center">${SPINNER_HTML} Preparing articles for review...</p>`;
            document.getElementById('report-panel').classList.add('hidden');
            document.getElementById('modification-panel').classList.add('hidden');
            document.getElementById('prisma-panel').classList.add('hidden');

            // 1. Identify Included Articles from Step 3
            const articlesToReview = appState.articles.filter(a => (a.Decision === 'INCLUDE' && !a.Override) || a.Override);

            if (articlesToReview.length === 0) {
                 updateStatus('No articles were included in the abstract phase. Cannot proceed with full text review.', 'info');
                 setButtonLoading('start-full-text-review-button', false);
                 return;
            }
            if (Object.keys(appState.uploadedTexts).length === 0) {
                 updateStatus('Please upload full text documents in Step 4 before starting the review, or wait for automatic retrieval to finish.', 'error');
                 setButtonLoading('start-full-text-review-button', false);
                 return;
            }

            // 2. Pair Articles with Uploaded Texts
            const reviewQueue = articlesToReview.map(article => {
                if (article.FullTextFileName && appState.uploadedTexts[article.FullTextFileName]) {
                    return {
                        article,
                        fullText: appState.uploadedTexts[article.FullTextFileName],
                        fileName: article.FullTextFileName
                    };
                }
                const matchingFileName = Object.keys(appState.uploadedTexts).find(filename => 
                    filename.includes(article.PMID)
                );
                if (matchingFileName) {
                    return {
                        article,
                        fullText: appState.uploadedTexts[matchingFileName],
                        fileName: matchingFileName
                    };
                }
                return null;
            }).filter(item => item !== null);
            
            if (reviewQueue.length === 0) {
                updateStatus('No full texts found for included articles. Ensure PMIDs are in the filenames.', 'error');
                setButtonLoading('start-full-text-review-button', false);
                return;
            }

            // 3. Run LLM review with Concurrency Limiter
            updateStatus(`**Starting Full Text Review & Data Extraction for ${reviewQueue.length} articles.**`, 'process');
            
            // Create array of task functions (not promises yet)
            const tasks = reviewQueue.map(queueItem => async () => {
                const llmResult = await reviewFullText(queueItem.article, appState.criteria, queueItem.fullText);
                
                const index = appState.articles.findIndex(a => a.PMID === queueItem.article.PMID);
                if (index !== -1) {
                    appState.articles[index].FinalDecision = llmResult.FinalDecision;
                    appState.articles[index].FinalReasoning = llmResult.FinalReasoning;
                    appState.articles[index].ExtractedData = {
                        StudyDesign: llmResult.StudyDesign,
                        SamplePopulation: llmResult.SamplePopulation,
                        KeyFindings: llmResult.KeyFindings
                    };
                    if (!appState.articles[index].FullTextFileName) {
                        appState.articles[index].FullTextFileName = queueItem.fileName;
                    }
                }
            });

            // Run tasks with limit of 3 concurrent requests to respect rate limits
            await runWithConcurrency(tasks, 3);
            
            renderFinalReviewResults();
            updateStatus(`Full Text Review & Extraction complete!`, 'success');
            setButtonLoading('start-full-text-review-button', false);
            
            document.getElementById('report-panel').classList.remove('hidden');
            document.getElementById('prisma-panel').classList.remove('hidden');
        }

        window.skipFullTextReview = () => {
            const includedCount = appState.articles.filter(a => (a.Decision === 'INCLUDE' && !a.Override) || a.Override).length;
            
            if (includedCount === 0) {
                updateStatus('No articles included from abstract screening. Cannot proceed.', 'error');
                return;
            }
            
            document.getElementById('report-panel').classList.remove('hidden');
            document.getElementById('prisma-panel').classList.remove('hidden');
            document.getElementById('full-text-review-panel').classList.add('hidden');
            updateStatus('Skipped Full Text Review. Proceeding with abstract data.', 'info');
            setTimeout(() => {
                document.getElementById('report-panel').scrollIntoView({ behavior: 'smooth' });
            }, 100);
        };


        // --- PMC Retrieval Functions ---

        async function fetchFullTextFromPMC(pmcid) {
            const url = `${PUBMED_BASE_URL}efetch.fcgi?db=pmc&id=${pmcid}&retmode=text&rettype=full&tool=${API_TOOL}&email=${API_EMAIL}`;
            try {
                const response = await fetchWithRetry(url);
                const fullText = await response.text();
                if (fullText.includes("cannot be found") || fullText.includes("error")) {
                    return null;
                }
                return fullText;
            } catch (error) {
                console.error(`Error fetching full text for PMCID ${pmcid}:`, error);
                return null;
            }
        }
        
        async function attemptFullTextRetrieval() {
            const includedArticles = appState.articles.filter(a => 
                ((a.Decision === 'INCLUDE' && !a.Override) || a.Override) && a.PMCID && !a.FullTextFileName
            );
            
            if (includedArticles.length === 0) {
                document.getElementById('retrieval-status-message').innerHTML = `No open-access articles (with PMC IDs) identified.`;
                document.getElementById('retrieval-status-message').classList.remove('hidden');
                return;
            }
            
            document.getElementById('retrieval-status-message').innerHTML = `<span class="flex items-center justify-center">${SPINNER_HTML} Retrieving full text for ${includedArticles.length} articles...</span>`;
            document.getElementById('retrieval-status-message').classList.remove('hidden');

            // Use concurrency for retrieval too
            // Reduced from 5 to 2 to respect NCBI rate limits (3 req/s without key) and prevent "Failed to fetch"
            const tasks = includedArticles.map(article => async () => {
                const fullText = await fetchFullTextFromPMC(article.PMCID);
                if (fullText) {
                    const fileName = `AUTO_PMC_${article.PMCID}_(PMID_${article.PMID}).txt`;
                    appState.uploadedTexts[fileName] = fullText;
                    const index = appState.articles.findIndex(a => a.PMID === article.PMID);
                    if (index !== -1) {
                        appState.articles[index].FullTextFileName = fileName;
                    }
                    return true;
                }
                return false;
            });

            const results = await runWithConcurrency(tasks, 2);
            const successCount = results.filter(r => r).length;
            
            if (successCount === 0) {
                document.getElementById('retrieval-status-message').innerHTML = `**PMC retrieval finished:** No full text articles could be retrieved.`;
                document.getElementById('retrieval-status-message').classList.add('bg-red-50', 'text-red-800');
            } else {
                document.getElementById('retrieval-status-message').innerHTML = `**PMC retrieval finished:** Downloaded ${successCount} articles.`;
                document.getElementById('retrieval-status-message').classList.add('bg-green-50', 'text-green-800');
            }

            renderFullTextUploadStatus();
        }


        // --- PubMed API Functions ---

        async function generateCriteriaAndQuery(researchQuestion) {
            setButtonLoading('generate-button', true);
            updateStatus('Drafting PICO & criteria...', 'process');

            const systemPrompt = `You are a systematic review methodologist. Output a structured PICO analysis, strict Inclusion/Exclusion criteria, and a robust, high-sensitivity search query suitable for a Systematic Literature Review (SLR). Output JSON.`;

            const userQuery = `
                Research Question: ${researchQuestion}

                Output the JSON object with:
                1. PICO: Object with Population, Intervention, Comparison, Outcome.
                2. Inclusion: String.
                3. Exclusion: String.
                4. SuggestedPubmedQuery: Comprehensive search query string using PubMed field tags ([MeSH Terms], [tiab]). Use truncation (*) and boolean OR for synonyms. Prioritize sensitivity.
            `;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "PICO": {
                                "type": "OBJECT",
                                "properties": {
                                    "Population": { "type": "STRING" },
                                    "Intervention": { "type": "STRING" },
                                    "Comparison": { "type": "STRING" },
                                    "Outcome": { "type": "STRING" }
                                }
                            },
                            "Inclusion": { "type": "STRING" },
                            "Exclusion": { "type": "STRING" },
                            "SuggestedPubmedQuery": { "type": "STRING" }
                        }
                    }
                }
            };
            
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${LLM_MODEL}:generateContent?key=${apiKey}`;

            try {
                const response = await fetchWithRetry(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (jsonText) {
                    const llmResult = JSON.parse(jsonText);
                    setButtonLoading('generate-button', false);
                    updateStatus('Criteria generated.', 'success');
                    return llmResult;
                } else {
                    throw new Error("Empty response.");
                }
            } catch (error) {
                console.error(error);
                setButtonLoading('generate-button', false);
                updateStatus(`Generation failed: ${error.message}`, 'error');
                return null;
            }
        }
        
        async function fetchPubmedUids(query, dateLimit) {
            updateStatus(`Searching PubMed...`, 'process');
            let url = `${PUBMED_BASE_URL}esearch.fcgi?db=pubmed&term=${encodeURIComponent(query)}&retmax=100&sort=relevance&retmode=json&tool=${API_TOOL}&email=${API_EMAIL}`;
            
            if (dateLimit && !isNaN(parseInt(dateLimit))) {
                const currentYear = new Date().getFullYear();
                url += `&mindate=${parseInt(dateLimit)}&maxdate=${currentYear}&datetype=pdat`;
            }

            const response = await fetchWithRetry(url);
            const data = await response.json();
            
            if (data.esearchresult && data.esearchresult.idlist) {
                return data.esearchresult.idlist;
            } else {
                throw new Error(data.esearchresult?.error || 'Search failed.');
            }
        }

        async function fetchAbstracts(uids) {
            if (uids.length === 0) return [];
            const chunkSize = 200; 
            const allArticles = [];

            for (let i = 0; i < uids.length; i += chunkSize) {
                const chunk = uids.slice(i, i + chunkSize);
                const uidString = chunk.join(',');
                updateStatus(`Retrieving abstracts...`, 'process');
                const url = `${PUBMED_BASE_URL}efetch.fcgi?db=pubmed&id=${uidString}&retmode=xml&rettype=abstract&tool=${API_TOOL}&email=${API_EMAIL}`;
                const response = await fetchWithRetry(url);
                const text = await response.text();
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(text, "application/xml");

                xmlDoc.querySelectorAll('PubmedArticle').forEach(articleEl => {
                    const pmidEl = articleEl.querySelector('PMID');
                    const titleEl = articleEl.querySelector('ArticleTitle');
                    const abstractEl = articleEl.querySelector('AbstractText');
                    let pmcid = null;
                    articleEl.querySelectorAll('ArticleId').forEach(id => {
                        if (id.getAttribute('IdType') === 'pmc') pmcid = id.textContent;
                    });

                    if (pmidEl && titleEl) {
                        allArticles.push({
                            PMID: pmidEl.textContent,
                            Title: titleEl.textContent || 'No Title Found',
                            Abstract: abstractEl ? abstractEl.textContent : 'No Abstract Available.',
                            PMCID: pmcid, 
                            Decision: 'PENDING',
                            Category: 'PENDING',
                            Reasoning: 'Awaiting LLM review.',
                            Override: false, 
                            FullTextFileName: null
                        });
                    }
                });
            }
            return allArticles;
        }

        async function screenArticle(article, criteria) {
            const systemPrompt = `You are a systematic review expert. Analyze the Title/Abstract against strict criteria. Output JSON.`;
            const userQuery = `
                PMID: ${article.PMID}
                Title: ${article.Title}
                Abstract: ${article.Abstract}
                Inclusion: ${criteria.Inclusion}
                Exclusion: ${criteria.Exclusion}
                Output JSON: { "Decision": "INCLUDE"|"EXCLUDE", "Category": string, "Reasoning": string }
            `;
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: { responseMimeType: "application/json", responseSchema: { type: "OBJECT", properties: { "Decision": { "type": "STRING", "enum": ["INCLUDE", "EXCLUDE"] }, "Category": { "type": "STRING" }, "Reasoning": { "type": "STRING" } } } }
            };
            
            try {
                const response = await fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/${LLM_MODEL}:generateContent?key=${apiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const result = await response.json();
                return JSON.parse(result.candidates?.[0]?.content?.parts?.[0]?.text);
            } catch (error) {
                console.error(error);
                return { Decision: 'ERROR', Category: 'ERROR', Reasoning: 'LLM failed.' };
            }
        }
        
        async function generateSLRReport() {
            setButtonLoading('generate-report-button', true);
            const outputEl = document.getElementById('slr-draft-output');
            outputEl.innerHTML = 'Drafting...';
            appState.currentDraft = ''; 

            const articlesToConsider = appState.articles.filter(a => {
                const isFinal = a.FinalDecision && a.FinalDecision === 'FINAL_INCLUDE';
                const isAbstractOnly = !a.FinalDecision && ((a.Decision === 'INCLUDE' && !a.Override) || a.Override);
                return isFinal || isAbstractOnly;
            });
            
            if (articlesToConsider.length === 0) {
                outputEl.innerHTML = 'No articles included.';
                setButtonLoading('generate-report-button', false);
                return;
            }

            // Enhanced Data Summary for the Report
            const articleDataSummary = articlesToConsider.map(a => {
                let extractionText = "";
                if (a.ExtractedData) {
                    extractionText = `
Study Design: ${a.ExtractedData.StudyDesign}
Sample: ${a.ExtractedData.SamplePopulation}
Key Findings: ${a.ExtractedData.KeyFindings}`;
                }
                return `PMID: ${a.PMID}
Title: ${a.Title}
Abstract: ${a.Abstract.substring(0, 300)}...
${extractionText}`;
            }).join('\n---\n');

            const researchQuestion = document.getElementById('research-question').value.trim();
            const criteriaText = document.getElementById('inclusion-criteria').value.trim();
            
            const systemPrompt = `You are a professional systematic review writer. Synthesize the articles into an academic draft. Structure: Introduction, Methods, Results (synthesize findings), Conclusion, References. Use inline citations (PMID: 12345).`;

            let userQuery = `
Question: ${researchQuestion}
Included Articles: ${articlesToConsider.length}
Criteria: ${criteriaText}
Data:
${articleDataSummary}
`;
            const draftingInstructions = document.getElementById('drafting-instructions').value.trim();
            if (draftingInstructions) userQuery += `\n\nInstructions: ${draftingInstructions}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };
            
            try {
                updateStatus('Drafting Report...', 'process');
                const response = await fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/${LLM_MODEL}:generateContent?key=${apiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const result = await response.json();
                const reportText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (reportText) {
                    appState.currentDraft = reportText;
                    let htmlReport = reportText.replace(/^#{1}\s*(.*)$/gm, '<h1>$1</h1>').replace(/^#{2}\s*(.*)$/gm, '<h2>$1</h2>').replace(/^#{3}\s*(.*)$/gm, '<h3>$1</h3>').replace(/\n/g, '<br>');
                    outputEl.innerHTML = htmlReport;
                    document.getElementById('modification-panel').classList.remove('hidden'); 
                    document.getElementById('prisma-panel').classList.remove('hidden');
                    updateStatus('Draft generated.', 'success');
                }
            } catch (error) {
                updateStatus(`Error: ${error.message}`, 'error');
            } finally {
                setButtonLoading('generate-report-button', false);
            }
        }
        
        async function refineSLRReport() {
            setButtonLoading('refine-report-button', true);
            const outputEl = document.getElementById('slr-draft-output');
            const modificationRequest = document.getElementById('modification-request').value.trim();

            const systemPrompt = `You are a professional editor. Revise the DRAFT REPORT based on the MODIFICATION REQUEST. Maintain citations.`;
            const userQuery = `DRAFT: ${appState.currentDraft}\n\nREQUEST: ${modificationRequest}`;
            
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };
            
            try {
                updateStatus('Refining...', 'process');
                const response = await fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/${LLM_MODEL}:generateContent?key=${apiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const result = await response.json();
                const revisedText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (revisedText) {
                    appState.currentDraft = revisedText; 
                    let htmlReport = revisedText.replace(/^#{1}\s*(.*)$/gm, '<h1>$1</h1>').replace(/^#{2}\s*(.*)$/gm, '<h2>$1</h2>').replace(/^#{3}\s*(.*)$/gm, '<h3>$1</h3>').replace(/\n/g, '<br>');
                    outputEl.innerHTML = htmlReport;
                    updateStatus('Refined.', 'success');
                }
            } catch (error) {
                updateStatus(`Error: ${error.message}`, 'error');
            } finally {
                setButtonLoading('refine-report-button', false);
            }
        }
        
        window.generatePrismaDiagram = () => {
            const outputEl = document.getElementById('prisma-output');
            outputEl.innerHTML = `<p class="text-gray-500 italic flex items-center justify-center">${SPINNER_HTML} Calculating...</p>`;
            
            const totalFound = appState.articles.length;
            const includedForFullText = appState.articles.filter(a => (a.Decision === 'INCLUDE' && !a.Override) || a.Override).length;
            const excludedByAbstract = appState.articles.filter(a => a.Decision === 'EXCLUDE' && !a.Override).length;
            const reviewedFullText = appState.articles.filter(a => a.FinalDecision).length;
            const includedInSynthesis = appState.articles.filter(a => a.FinalDecision === 'FINAL_INCLUDE').length;
            const excludedByFullText = appState.articles.filter(a => a.FinalDecision === 'FINAL_EXCLUDE').length;
            const notReviewedFullText = includedForFullText - reviewedFullText;
            
            let synthesisTotal = (reviewedFullText === 0 && includedForFullText > 0) ? includedForFullText : includedInSynthesis;

            const boxWidth = 260; const boxHeight = 64; const xCenter = 400; 
            const yPhase1 = 30; const yPhase2 = 150; const yPhase3 = 270; const yExclusionLayer = 390; const yPhase4 = 520;
            
            const drawBox = (x, y, text1, text2, color) => `<rect x="${x - boxWidth / 2}" y="${y}" width="${boxWidth}" height="${boxHeight}" rx="8" ry="8" fill="#FFFFFF" stroke="${color}" stroke-width="2"/><text x="${x}" y="${y + 24}" font-weight="bold" fill="#333" font-size="14" text-anchor="middle">${text1}</text><text x="${x}" y="${y + 44}" fill="#555" font-size="12" text-anchor="middle">${text2}</text>`;
            const drawArrow = (x1, y1, x2, y2) => `<line x1="${x1}" y1="${y1}" x2="${x2}" y2="${y2}" stroke="#6b7280" stroke-width="2" marker-end="url(#arrowhead)"/>`;
            
            const svgContent = `<svg width="100%" height="650" viewBox="0 0 800 650" xmlns="http://www.w3.org/2000/svg" style="font-family: 'Inter', sans-serif;"><defs><marker id="arrowhead" markerWidth="10" markerHeight="7" refX="0" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="#6b7280" /></marker></defs>
                ${drawBox(xCenter, yPhase1, 'Identification', `Records identified (${totalFound})`, '#2563EB')}
                ${drawArrow(xCenter, yPhase1 + boxHeight, xCenter, yPhase2)}
                ${drawBox(xCenter, yPhase2, 'Screening', `Records screened (${totalFound})`, '#2563EB')}
                <line x1="${xCenter + boxWidth/2}" y1="${yPhase2 + boxHeight/2}" x2="${xCenter + boxWidth/2 + 30}" y2="${yPhase2 + boxHeight/2}" stroke="#EF4444" stroke-width="2" marker-end="url(#arrowhead)"/>
                <rect x="${xCenter + boxWidth/2 + 40}" y="${yPhase2 + 12}" width="160" height="40" rx="6" ry="6" fill="#FEE2E2" stroke="#EF4444" stroke-width="2"/>
                <text x="${xCenter + boxWidth/2 + 120}" y="${yPhase2 + 36}" fill="#EF4444" font-size="11" text-anchor="middle">Excluded (${excludedByAbstract})</text>
                ${drawArrow(xCenter, yPhase2 + boxHeight, xCenter, yPhase3)}
                ${drawBox(xCenter, yPhase3, 'Eligibility', `Full-text assessed (${includedForFullText})`, '#9333EA')}
                <line x1="${xCenter}" y1="${yPhase3 + boxHeight}" x2="${xCenter}" y2="${yExclusionLayer - 25}" stroke="#6b7280" stroke-width="2"/>
                <line x1="${xCenter - 180}" y1="${yExclusionLayer - 25}" x2="${xCenter + 180}" y2="${yExclusionLayer - 25}" stroke="#6b7280" stroke-width="2"/>
                <line x1="${xCenter - 180}" y1="${yExclusionLayer - 25}" x2="${xCenter - 180}" y2="${yExclusionLayer}" stroke="#EF4444" stroke-width="2" marker-end="url(#arrowhead)"/>
                <rect x="${xCenter - 270}" y="${yExclusionLayer}" width="180" height="55" rx="6" ry="6" fill="#FEE2E2" stroke="#EF4444" stroke-width="2"/>
                <text x="${xCenter - 180}" y="${yExclusionLayer + 22}" fill="#EF4444" font-size="11" text-anchor="middle" font-weight="bold">Not Retrieved</text>
                <text x="${xCenter - 180}" y="${yExclusionLayer + 40}" fill="#EF4444" font-size="11" text-anchor="middle">(${notReviewedFullText})</text>
                <line x1="${xCenter + 180}" y="${yExclusionLayer - 25}" x2="${xCenter + 180}" y2="${yExclusionLayer}" stroke="#EF4444" stroke-width="2" marker-end="url(#arrowhead)"/>
                <rect x="${xCenter + 90}" y="${yExclusionLayer}" width="180" height="55" rx="6" ry="6" fill="#FEE2E2" stroke="#EF4444" stroke-width="2"/>
                <text x="${xCenter + 180}" y="${yExclusionLayer + 22}" fill="#EF4444" font-size="11" text-anchor="middle" font-weight="bold">Excluded by Review</text>
                <text x="${xCenter + 180}" y="${yExclusionLayer + 40}" fill="#EF4444" font-size="11" text-anchor="middle">(${excludedByFullText})</text>
                <line x1="${xCenter}" y1="${yExclusionLayer - 25}" x2="${xCenter}" y2="${yPhase4}" stroke="#6b7280" stroke-width="2" marker-end="url(#arrowhead)"/>
                ${drawBox(xCenter, yPhase4, 'Included', `Included in Review (${synthesisTotal})`, '#059669')}
            </svg>`;
            
            outputEl.innerHTML = svgContent;
            updateStatus('PRISMA generated.', 'success');
        };

        function renderArticleCard(article) {
            let statusClasses = '', statusText = article.Decision, actionButton = '';
            const isIncluded = (article.Decision === 'INCLUDE' && !article.Override) || article.Override;
            if (isIncluded) {
                statusClasses = 'bg-green-100 text-green-800 border-green-300';
                statusText = article.Override ? 'INCLUDED (Human Override)' : 'INCLUDED (AI)';
            } else if (article.Decision === 'EXCLUDE' || article.Decision === 'ERROR') {
                statusClasses = 'bg-red-100 text-red-800 border-red-300';
                statusText = article.Decision === 'EXCLUDE' ? 'EXCLUDED (AI)' : 'ERROR';
                if (article.Decision === 'EXCLUDE') actionButton = `<button onclick="window.handleOverride('${article.PMID}')" class="mt-4 w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">Override & Include</button>`;
            }
            const pmcBadge = article.PMCID ? `<span class="inline-flex items-center rounded-full bg-purple-100 px-2 py-0.5 text-xs font-medium text-purple-800">PMC ID: ${article.PMCID.replace('PMC', '')}</span>` : '';

            return `<div id="card-${article.PMID}" class="article-card p-4 rounded-xl border-t-4 ${statusClasses}">
                <a href="https://pubmed.ncbi.nlm.nih.gov/${article.PMID}/" target="_blank" class="text-lg font-bold text-blue-800 hover:underline block">${article.Title}</a>
                <div class="flex flex-wrap gap-2 items-center mb-2"><p class="text-xs text-gray-500">PMID: ${article.PMID} | Category: <span class="font-semibold">${article.Category}</span></p>${pmcBadge}</div>
                <div class="my-2 p-2 rounded-lg text-sm font-medium ${statusClasses} border">Status: ${statusText}</div>
                <p class="text-sm text-gray-700 font-semibold mt-3">AI Reasoning (Abstract):</p><p class="text-sm text-gray-600 italic mb-3">"${article.Reasoning}"</p>
                <details class="text-xs text-gray-500 cursor-pointer mt-2"><summary>View Abstract</summary><p class="mt-1 p-2 bg-gray-50 rounded">${article.Abstract}</p></details>
                ${actionButton}
            </div>`;
        }

        function renderFinalReviewCard(article) {
            let statusClasses = '', statusText = article.FinalDecision;
            if (article.FinalDecision === 'FINAL_INCLUDE') {
                statusClasses = 'bg-purple-100 text-purple-800 border-purple-300';
                statusText = 'FINAL INCLUDED';
            } else {
                statusClasses = 'bg-red-100 text-red-800 border-red-300';
                statusText = 'FINAL EXCLUDED';
            }
            
            // Extraction Display
            let extractionHtml = '';
            if (article.FinalDecision === 'FINAL_INCLUDE' && article.ExtractedData) {
                extractionHtml = `
                    <div class="mt-3 p-3 bg-white rounded border border-purple-200 text-xs">
                        <p><strong>Study Design:</strong> ${article.ExtractedData.StudyDesign}</p>
                        <p><strong>Sample:</strong> ${article.ExtractedData.SamplePopulation}</p>
                        <p><strong>Findings:</strong> ${article.ExtractedData.KeyFindings}</p>
                    </div>
                `;
            }

            return `<div id="final-card-${article.PMID}" class="article-card p-4 rounded-xl border-t-4 ${statusClasses}">
                <a href="https://pubmed.ncbi.nlm.nih.gov/${article.PMID}/" target="_blank" class="text-lg font-bold text-blue-800 hover:underline block">${article.Title}</a>
                <div class="my-2 p-2 rounded-lg text-sm font-medium ${statusClasses} border">Status: ${statusText}</div>
                <p class="text-sm text-gray-700 font-semibold mt-2">Reasoning:</p><p class="text-sm text-gray-600 italic mb-2">"${article.FinalReasoning}"</p>
                ${extractionHtml}
            </div>`;
        }

        function renderResults() {
            const included = appState.articles.filter(a => (a.Decision === 'INCLUDE' && !a.Override) || a.Override);
            const excluded = appState.articles.filter(a => a.Decision === 'EXCLUDE' && !a.Override);
            document.getElementById('included-list').innerHTML = included.map(renderArticleCard).join('');
            document.getElementById('excluded-list').innerHTML = excluded.map(renderArticleCard).join('');
            document.getElementById('included-count').textContent = included.length;
            document.getElementById('excluded-count').textContent = excluded.length;
            document.getElementById('results-panel').classList.remove('hidden');
            if (included.length > 0) {
                document.getElementById('upload-panel').classList.remove('hidden');
                attemptFullTextRetrieval();
            } else {
                 document.getElementById('upload-panel').classList.add('hidden');
            }
        }
        
        function renderFinalReviewResults() {
            const reviewed = appState.articles.filter(a => a.FinalDecision);
            if (reviewed.length === 0) return;
            document.getElementById('final-review-list').innerHTML = reviewed.map(renderFinalReviewCard).join('');
        }

        function renderFullTextUploadStatus() {
            const fileListContainer = document.getElementById('fileListContainer');
            const fileNames = Object.keys(appState.uploadedTexts).sort((a, b) => (a.startsWith('AUTO_') === b.startsWith('AUTO_')) ? 0 : a.startsWith('AUTO_') ? -1 : 1);
            if (fileNames.length === 0) {
                fileListContainer.innerHTML = '<p id="initialMessage" class="text-center text-gray-500 italic p-3">Uploaded documents appear here.</p>';
                document.getElementById('start-full-text-review-button').classList.add('hidden');
                return;
            }
            fileListContainer.innerHTML = fileNames.map(fileName => {
                const content = appState.uploadedTexts[fileName];
                const isAuto = fileName.startsWith('AUTO_');
                return `<div class="file-card p-3 rounded-xl shadow-sm border-l-4 ${isAuto ? 'border-green-500 bg-green-50' : 'border-purple-500 bg-white'} mb-2">
                    <div class="flex justify-between"><span class="font-bold text-sm text-gray-700 truncate w-3/4">${fileName}</span>${isAuto ? '<span class="text-xs text-green-600 font-bold">Auto</span>' : ''}</div>
                </div>`;
            }).join('');
            document.getElementById('start-full-text-review-button').classList.remove('hidden');
        }

        window.handleFileSelect = async () => {
            const files = Array.from(document.getElementById('fileInput').files);
            if (files.length === 0) return;

            // Clear manual only
            Object.keys(appState.uploadedTexts).forEach(key => { if (!key.startsWith('AUTO_')) delete appState.uploadedTexts[key]; });

            for (const file of files) {
                const fileName = file.name;
                try {
                    let content = '';
                    if (file.type === 'application/pdf' || fileName.endsWith('.pdf')) {
                         const arrayBuffer = await file.arrayBuffer();
                         const pdf = await window.pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                         for (let i = 1; i <= pdf.numPages; i++) {
                             const page = await pdf.getPage(i);
                             const textContent = await page.getTextContent();
                             content += textContent.items.map(item => item.str).join(' ') + '\n';
                         }
                    } else {
                        content = await new Promise((resolve) => {
                            const reader = new FileReader();
                            reader.onload = (e) => resolve(e.target.result);
                            reader.readAsText(file);
                        });
                    }
                    appState.uploadedTexts[fileName] = content;
                } catch (err) { console.error(err); }
            }
            renderFullTextUploadStatus();
        };

        window.handleOverride = (pmid) => {
            const article = appState.articles.find(a => a.PMID === pmid);
            if (article) { article.Override = true; renderResults(); updateStatus(`PMID ${pmid} manually included.`, 'info'); }
        };

        async function handleCriteriaGeneration(event) {
            event.preventDefault();
            const researchQuestion = document.getElementById('research-question').value.trim();
            if (!researchQuestion) return;
            appState.dateLimit = document.getElementById('date-limit').value.trim();

            const llmOutput = await generateCriteriaAndQuery(researchQuestion);
            if (llmOutput) {
                document.getElementById('pubmed-query').value = llmOutput.SuggestedPubmedQuery || '';
                if (llmOutput.PICO) {
                    document.getElementById('pico-p').textContent = llmOutput.PICO.Population || 'N/A';
                    document.getElementById('pico-i').textContent = llmOutput.PICO.Intervention || 'N/A';
                    document.getElementById('pico-c').textContent = llmOutput.PICO.Comparison || 'N/A';
                    document.getElementById('pico-o').textContent = llmOutput.PICO.Outcome || 'N/A';
                    document.getElementById('pico-container').classList.remove('hidden');
                }
                document.getElementById('inclusion-criteria').value = JSON.stringify({ Inclusion: llmOutput.Inclusion, Exclusion: llmOutput.Exclusion }, null, 2);
                appState.criteria = { Inclusion: llmOutput.Inclusion, Exclusion: llmOutput.Exclusion };
                appState.pubmedQuery = llmOutput.SuggestedPubmedQuery;
                document.getElementById('review-panel').classList.remove('hidden');
            }
        }

        async function startScreening(event) {
            event.preventDefault();
            setButtonLoading('start-screening-button', true);
            // Reset State
            appState.articles = []; appState.uploadedTexts = {}; appState.currentDraft = '';
            ['results-panel','upload-panel','full-text-review-panel','report-panel','modification-panel','prisma-panel'].forEach(id => document.getElementById(id).classList.add('hidden'));
            
            try {
                appState.criteria = JSON.parse(document.getElementById('inclusion-criteria').value);
                appState.pubmedQuery = document.getElementById('pubmed-query').value;
                
                const uids = await fetchPubmedUids(appState.pubmedQuery, appState.dateLimit);
                if (uids.length === 0) { updateStatus("No articles found.", 'info'); setButtonLoading('start-screening-button', false); return; }
                
                const rawArticles = await fetchAbstracts(uids);
                updateStatus(`Screening ${rawArticles.length} abstracts (Concurrent Batches)...`, 'process');

                // CONCURRENCY CONTROLLED SCREENING
                const tasks = rawArticles.map(article => async () => {
                    const result = await screenArticle(article, appState.criteria);
                    return { ...article, ...result };
                });
                
                // Limit to 5 simultaneous abstract screening requests
                appState.articles = await runWithConcurrency(tasks, 5);

                renderResults();
                updateStatus(`Screening complete.`, 'success');
            } catch (error) {
                console.error(error);
                updateStatus(`Error: ${error.message}`, 'error');
            } finally {
                setButtonLoading('start-screening-button', false);
            }
        }

        window.exportResults = (format) => {
            const articles = appState.articles;
            if (format === 'json') {
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(articles, null, 2));
                const a = document.createElement('a'); a.href = dataStr; a.download = "slr_results.json"; a.click();
            } else if (format === 'csv') {
                const headers = ["PMID", "Title", "Abstract_Decision", "Abstract_Reasoning", "FullText_Decision", "FullText_Reasoning", "Extracted_Design", "Extracted_Sample", "Extracted_Findings"];
                const rows = articles.map(a => [
                    a.PMID,
                    `"${(a.Title || '').replace(/"/g, '""')}"`,
                    a.Decision,
                    `"${(a.Reasoning || '').replace(/"/g, '""')}"`,
                    a.FinalDecision || "N/A",
                    `"${(a.FinalReasoning || '').replace(/"/g, '""')}"`,
                    `"${(a.ExtractedData?.StudyDesign || '').replace(/"/g, '""')}"`,
                    `"${(a.ExtractedData?.SamplePopulation || '').replace(/"/g, '""')}"`,
                    `"${(a.ExtractedData?.KeyFindings || '').replace(/"/g, '""')}"`
                ]);
                const csvContent = "data:text/csv;charset=utf-8," + [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
                const a = document.createElement('a'); a.href = encodeURI(csvContent); a.download = "slr_results.csv"; a.click();
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('criteria-form').addEventListener('submit', handleCriteriaGeneration);
            document.getElementById('screening-form').addEventListener('submit', startScreening);
            document.getElementById('generate-report-button').addEventListener('click', generateSLRReport);
            document.getElementById('refine-report-button').addEventListener('click', refineSLRReport); 
            updateStatus('Ready.', 'info');
        });
    </script>
</body>
</html>

