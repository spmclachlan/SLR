<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI-Assisted SLR Screener v9.1 (Citations Fixed)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
        .scroll-container { max-height: 70vh; overflow-y: auto; border: 1px solid #e5e7eb; background-color: white; padding: 1rem; }
        .article-card { transition: transform 0.2s; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .article-card:hover { transform: translateY(-2px); }
        #slr-draft-output { white-space: pre-wrap; font-family: 'Georgia', serif; line-height: 1.6; color: #1f2937; }
        #slr-draft-output h1 { font-size: 2rem; font-weight: bold; margin-top: 2rem; margin-bottom: 1rem; border-bottom: 2px solid #e5e7eb; color: #111827; }
        #slr-draft-output h2 { font-size: 1.5rem; font-weight: bold; margin-top: 1.5rem; margin-bottom: 0.75rem; color: #374151; }
        #slr-draft-output h3 { font-size: 1.25rem; font-weight: bold; margin-top: 1.25rem; color: #4b5563; }
        .modal { transition: opacity 0.25s ease; }
        body.modal-active { overflow-x: hidden; overflow-y: visible !important; }
        .tab-btn { border-bottom: 2px solid transparent; }
        .tab-btn.active { border-bottom-color: #2563EB; color: #1E40AF; background-color: #EFF6FF; }
    </style>
</head>
<body>
    <div class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8 relative">
        
        <!-- Top Controls -->
        <div class="absolute top-4 right-4 z-10 flex gap-2">
            <input type="file" id="load-project-input" class="hidden" accept=".slr,.json" onchange="window.loadProject(this)">
            <button onclick="document.getElementById('load-project-input').click()" class="text-gray-600 hover:text-blue-700 bg-white px-3 py-1 rounded shadow border text-sm flex items-center transition">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg> Load
            </button>
            <button onclick="window.saveProject()" class="text-gray-600 hover:text-blue-700 bg-white px-3 py-1 rounded shadow border text-sm flex items-center transition">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path></svg> Save
            </button>
            <button onclick="window.downloadAuditLog()" class="text-gray-500 hover:text-blue-700 bg-white px-3 py-1 rounded shadow border text-sm transition" title="Download Audit Log">Audit Log</button>
            <button onclick="toggleModal('settings-modal')" class="text-gray-500 hover:text-gray-700 focus:outline-none transition">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
            </button>
        </div>

        <header class="text-center mb-8 p-6 bg-white rounded-xl shadow-lg">
            <h1 class="text-4xl font-extrabold text-blue-800">AI-Assisted SLR Screener <span class="text-sm font-normal text-white bg-indigo-600 px-2 py-1 rounded ml-2">v9.1 Citations</span></h1>
            <p class="text-lg text-gray-600 mt-2">Comprehensive review with Full Metadata Extraction & PRISMA 2020.</p>
        </header>

        <!-- GLOBAL PROGRESS BAR -->
        <div id="progress-container" class="hidden mb-6 bg-white p-4 rounded-xl shadow-md border border-gray-200 transition-all">
            <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden shadow-inner">
                <div id="progress-bar" class="bg-blue-600 h-4 rounded-full transition-all duration-500 ease-out" style="width: 0%"></div>
            </div>
            <p id="progress-text" class="text-center text-sm font-bold text-gray-700 mt-2">Preparing...</p>
        </div>

        <div id="status-message" class="text-center text-lg font-medium py-4 rounded-lg shadow-inner hidden mb-4"></div>

        <!-- Step 1: Protocol -->
        <div id="input-panel" class="bg-white p-6 rounded-xl shadow-lg mb-8">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">1. Research Protocol</h2>
            <form id="criteria-form">
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Research Question / PICO:</label>
                    <textarea id="research-question" rows="3" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="e.g. Efficacy of GLP-1 agonists in adolescents with Type 2 Diabetes..."></textarea>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Option A: Search PubMed</label>
                        <div class="flex gap-2 mb-2">
                            <input type="text" id="pubmed-query-input" placeholder="Query will auto-generate..." class="flex-1 p-3 border border-gray-300 rounded-lg font-mono text-sm">
                        </div>
                        <div class="flex gap-2">
                            <div class="flex-1">
                                <label class="text-xs text-gray-500">Date Limit (Year)</label>
                                <input type="number" id="date-limit" placeholder="e.g. 2020" class="w-full p-2 border border-gray-300 rounded-lg text-sm">
                            </div>
                            <div class="flex-1">
                                <label class="text-xs text-gray-500">Max Results</label>
                                <input type="number" id="max-results" value="200" min="10" max="2000" class="w-full p-2 border border-gray-300 rounded-lg text-sm font-bold text-blue-800">
                            </div>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Option B: Import RIS (EndNote/Scopus)</label>
                        <input type="file" id="ris-upload" accept=".ris,.txt" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                    </div>
                </div>
                <button type="submit" id="generate-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow transition">Generate Protocol & Load Data</button>
            </form>
        </div>
        
        <!-- Step 1.5: Calibration -->
        <div id="calibration-panel" class="hidden bg-white p-6 rounded-xl shadow-lg mb-8 border-l-4 border-purple-500">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-semibold text-gray-800">üî¨ Calibration Phase</h2>
                <span id="kappa-display" class="kappa-badge text-sm font-bold bg-gray-100 px-3 py-1 rounded-full">Kappa: Pending</span>
            </div>
            <p class="text-gray-600 mb-4">Blindly screen these <span id="calib-count">5</span> articles. The AI (Dual Agents) will screen in background.</p>
            <div id="calibration-card" class="bg-gray-50 p-6 rounded-lg border border-gray-200 mb-4 relative min-h-[200px]">
                <div id="calib-content"></div>
                <div id="calib-overlay" class="absolute inset-0 bg-white bg-opacity-90 flex flex-col items-center justify-center hidden">
                    <h3 class="text-xl font-bold text-gray-800 mb-2">Calibration Complete</h3>
                    <p id="calib-result-text" class="text-lg mb-4 font-semibold"></p>
                    <button onclick="window.finishCalibration()" class="bg-purple-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-purple-700">Proceed to Full Screening</button>
                </div>
            </div>
            <div class="flex justify-center gap-4" id="calib-controls">
                <button onclick="window.calibVote('EXCLUDE')" class="bg-red-100 text-red-700 px-6 py-3 rounded-lg font-bold hover:bg-red-200 w-1/3">Exclude ‚ùå</button>
                <button onclick="window.calibVote('INCLUDE')" class="bg-green-100 text-green-700 px-6 py-3 rounded-lg font-bold hover:bg-green-200 w-1/3">Include ‚úÖ</button>
            </div>
        </div>

        <!-- Step 2: Review Protocol -->
        <div id="review-panel" class="bg-white p-6 rounded-xl shadow-lg mb-8 hidden">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">2. Protocol Review</h2>
            <div class="bg-indigo-50 p-4 rounded-lg mb-4 text-sm text-indigo-800 border border-indigo-100 flex items-start">
                <svg class="w-6 h-6 mr-3 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                <div>
                    <strong>Dual-Agent Screening Active:</strong> Reviewer A (Sensitive) vs Reviewer B (Strict). Disagreements = Conflict.
                </div>
            </div>
            <div id="pico-container" class="mb-6 p-4 bg-blue-50 rounded-lg border border-blue-200 hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                    <div class="bg-white p-3 rounded shadow-sm border-l-4 border-blue-500"><span class="block font-bold text-gray-500 text-xs">P</span><span id="pico-p"></span></div>
                    <div class="bg-white p-3 rounded shadow-sm border-l-4 border-green-500"><span class="block font-bold text-gray-500 text-xs">I</span><span id="pico-i"></span></div>
                    <div class="bg-white p-3 rounded shadow-sm border-l-4 border-orange-500"><span class="block font-bold text-gray-500 text-xs">C</span><span id="pico-c"></span></div>
                    <div class="bg-white p-3 rounded shadow-sm border-l-4 border-purple-500"><span class="block font-bold text-gray-500 text-xs">O</span><span id="pico-o"></span></div>
                </div>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Inclusion/Exclusion (JSON)</label>
                <textarea id="inclusion-criteria" rows="6" class="w-full p-3 border border-gray-300 rounded-lg font-mono text-sm"></textarea>
            </div>
            <div class="flex gap-4">
                <button onclick="window.startCalibration()" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg shadow transition">Start Calibration</button>
                <button onclick="window.startScreening({skipCalibration:true})" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded-lg transition">Skip & Screen All (<span id="total-articles-count">0</span>)</button>
            </div>
        </div>

        <!-- Step 3: Results -->
        <div id="results-panel" class="hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b-4 border-blue-200 pb-2">3. Screening Results</h2>
            <div class="flex border-b border-gray-200 mb-6">
                <button onclick="switchTab('included')" id="tab-included" class="tab-btn active px-6 py-3 font-medium text-sm">Included (<span id="included-count">0</span>)</button>
                <button onclick="switchTab('borderline')" id="tab-borderline" class="tab-btn px-6 py-3 font-medium text-sm text-yellow-600">Conflicts (<span id="borderline-count">0</span>)</button>
                <button onclick="switchTab('excluded')" id="tab-excluded" class="tab-btn px-6 py-3 font-medium text-sm text-gray-500">Excluded (<span id="excluded-count">0</span>)</button>
            </div>
            <div id="content-included" class="tab-content"><div id="included-list" class="scroll-container grid gap-4 grid-cols-1 md:grid-cols-2"></div></div>
            <div id="content-borderline" class="tab-content hidden"><div id="borderline-list" class="scroll-container grid gap-4 grid-cols-1 md:grid-cols-2 bg-yellow-50 border-yellow-200"></div></div>
            <div id="content-excluded" class="tab-content hidden"><div id="excluded-list" class="scroll-container grid gap-4 grid-cols-1 md:grid-cols-2"></div></div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-8">
                 <button onclick="window.exportResults('json')" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg">Export JSON</button>
                <button onclick="window.exportResults('csv')" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-4 rounded-lg">Export CSV</button>
            </div>
        </div>
        
        <!-- Step 4: Full Text & Extraction Config -->
        <div id="upload-panel" class="bg-white p-6 rounded-xl shadow-lg mt-8 hidden">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">4. Full Text & Extraction Config</h2>
            
            <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-6">
                <label class="block text-sm font-bold text-gray-700 mb-2">Define Quantitative Extraction Schema</label>
                <input type="text" id="extraction-fields" value="Sample Size (N), Mean Age, Intervention Dosage, Primary Outcome Result (Mean/SD), P-Value, Adverse Events (N)" class="w-full p-2 border border-gray-300 rounded text-sm font-mono text-blue-800">
                <p class="text-xs text-gray-500 mt-1">The AI will extract these specific columns for every included study.</p>
            </div>

            <div id="retrieval-status-message" class="mb-4 p-3 rounded-lg bg-yellow-50 text-yellow-800 font-medium hidden"></div>
            <div class="border-2 border-dashed border-purple-200 p-6 rounded-xl bg-purple-50 mb-4">
                <input type="file" id="fileInput" accept=".txt,.md,.log,.csv,.pdf" multiple class="hidden" onchange="window.handleFileSelect()">
                <label for="fileInput" class="file-upload-label flex flex-col items-center justify-center p-8 border-4 border-purple-500 rounded-lg bg-purple-100 text-purple-700 hover:bg-purple-200">
                    <span class="text-lg font-semibold">Click to upload PDFs/Text</span>
                </label>
            </div>
            <div class="flex gap-4">
                 <button id="start-full-text-review-button" onclick="window.startFullTextReview()" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg shadow opacity-50 cursor-not-allowed" disabled>Start Extraction & RoB</button>
                <button id="skip-full-text-button" onclick="window.skipFullTextReview()" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded-lg">Skip Full Text</button>
            </div>
            <div id="fileListContainer" class="mt-4 space-y-4"></div>
        </div>
        
        <!-- Step 5: Extracted Data -->
        <div id="full-text-review-panel" class="bg-white p-6 rounded-xl shadow-lg mt-8 hidden">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">5. Extracted Data & RoB</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full text-xs text-left" id="extraction-table">
                    <thead class="bg-gray-50 border-b"><tr><th class="p-2">PMID</th><th class="p-2">Decision</th><th class="p-2">Data</th><th class="p-2">RoB</th></tr></thead>
                    <tbody id="extraction-table-body"></tbody>
                </table>
            </div>
        </div>

        <!-- Step 6: Report -->
        <div id="report-panel" class="bg-white p-6 rounded-xl shadow-lg mt-8 hidden">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2 flex justify-between items-center">
                <span>6. Final Report</span>
                <button onclick="window.checkPrisma()" class="text-xs bg-indigo-100 text-indigo-700 px-3 py-1 rounded hover:bg-indigo-200 border border-indigo-300">‚úÖ PRISMA Checklist</button>
            </h2>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Drafting Instructions:</label>
                <textarea id="drafting-instructions" rows="2" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="e.g., Focus on statistical heterogeneity..."></textarea>
            </div>
            <div class="flex gap-4 mb-4">
                <button id="generate-report-button" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg">Generate Full Report (w/ Bibliography)</button>
                <button id="generate-prisma-button" onclick="window.generatePrismaDiagram()" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded-lg">Generate PRISMA Diagram</button>
            </div>
            <div id="slr-draft-output" class="mt-6 p-8 border border-gray-200 rounded-lg bg-white shadow-sm max-h-[70vh] overflow-y-auto"></div>
            <div id="prisma-output" class="mt-6 p-4 rounded-lg bg-white overflow-x-auto text-center"></div>
            <div id="refine-section" class="mt-6 pt-6 border-t border-gray-200 hidden">
                <h3 class="text-lg font-bold text-gray-800 mb-2">Refine This Draft</h3>
                <div class="flex gap-2">
                    <textarea id="refine-instructions" rows="2" class="flex-1 p-3 border border-gray-300 rounded-lg" placeholder="e.g., Expand the conclusion..."></textarea>
                    <button id="refine-button" class="bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-4 rounded-lg">Refine</button>
                </div>
            </div>
        </div>

    </div>

    <!-- PRISMA Checklist Modal -->
    <div id="prisma-modal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50" onclick="toggleModal('prisma-modal')"></div>
        <div class="modal-container bg-white w-11/12 md:max-w-lg mx-auto rounded shadow-lg z-50 overflow-y-auto p-6 max-h-[80vh]">
            <h3 class="text-xl font-bold mb-4">PRISMA 2020 Pre-Flight Check</h3>
            <div class="space-y-2 text-sm text-gray-700" id="prisma-list">
                <!-- Populated by JS -->
            </div>
            <div class="mt-6 flex justify-end">
                <button onclick="toggleModal('prisma-modal')" class="bg-blue-600 text-white px-4 py-2 rounded">Close</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50" onclick="toggleModal('settings-modal')"></div>
        <div class="modal-container bg-white w-11/12 md:max-w-md mx-auto rounded shadow-lg z-50 overflow-y-auto">
            <div class="modal-content py-4 text-left px-6">
                <div class="flex justify-between items-center pb-3"><p class="text-2xl font-bold">Settings</p><div class="modal-close cursor-pointer z-50" onclick="toggleModal('settings-modal')">x</div></div>
                <div class="my-5"><label class="block text-sm font-medium text-gray-700">Gemini API Key</label><input type="password" id="api-key-input" class="w-full p-2 border rounded"></div>
                <div class="flex justify-end"><button onclick="saveSettings()" class="px-4 py-2 bg-blue-600 text-white rounded font-bold">Save</button></div>
            </div>
        </div>
    </div>

    <script type="module">
        const apiKey = "AIzaSyDpqUR_N4g_lHf1zAW53st7iTWpDQlkXsM";
        const LLM_MODEL = "gemini-2.5-flash-preview-09-2025";
        const PUBMED_BASE_URL = 'https://eutils.ncbi.nlm.nih.gov/entrez/eutils/';
        const API_TOOL = "slr_screener_bot";
        const API_EMAIL = "example@example.com";
        const CONCURRENCY_LIMIT = 4;

        let appState = {
            articles: [],
            criteria: {},
            calibrationSet: [],
            calibrationIndex: 0,
            humanVotes: {},
            aiVotes: {},
            auditLog: [],
            uploadedTexts: {},
            currentDraft: "",
            abortProcessing: false,
            extractionSchema: []
        };

        // --- Utils ---
        function getApiKey() { return localStorage.getItem('custom_api_key') || apiKey; }
        window.saveSettings = () => { localStorage.setItem('custom_api_key', document.getElementById('api-key-input').value); toggleModal('settings-modal'); };
        window.toggleModal = (id) => { document.getElementById(id).classList.toggle("opacity-0"); document.getElementById(id).classList.toggle("pointer-events-none"); document.body.classList.toggle("modal-active"); };
        window.switchTab = (t) => { ['included','borderline','excluded'].forEach(x => { document.getElementById(`tab-${x}`).classList.remove('active','text-blue-800','bg-blue-50'); document.getElementById(`content-${x}`).classList.add('hidden'); }); document.getElementById(`tab-${t}`).classList.add('active'); document.getElementById(`content-${t}`).classList.remove('hidden'); };
        
        function updateStatus(msg, type='info') {
            const el = document.getElementById('status-message');
            el.innerHTML = msg; 
            el.className = `text-center text-lg font-medium py-4 rounded-lg shadow-inner mb-4 ${type==='error'?'bg-red-100 text-red-800':(type==='success'?'bg-green-100 text-green-800':'bg-blue-100 text-blue-800')}`;
            el.classList.remove('hidden');
        }

        function setButtonLoading(id, isLoading) {
            const btn = document.getElementById(id);
            if(!btn) return;
            if (isLoading) { btn.dataset.originalText = btn.innerText; btn.innerText = "Processing..."; btn.disabled = true; } 
            else { btn.innerText = btn.dataset.originalText || "Submit"; btn.disabled = false; }
        }
        
        function setProgressBar(percent, message) {
            const container = document.getElementById('progress-container');
            const bar = document.getElementById('progress-bar');
            const text = document.getElementById('progress-text');
            if (percent !== null) {
                container.classList.remove('hidden');
                bar.style.width = `${percent}%`;
                if (message) text.textContent = message;
            } else {
                container.classList.add('hidden');
                bar.style.width = '0%';
            }
        }

        function logAudit(action, details) { appState.auditLog.push({ timestamp: new Date().toISOString(), action, details }); }
        function extractJson(text) { const start = text.indexOf('{'); const end = text.lastIndexOf('}'); if (start !== -1 && end !== -1) return text.substring(start, end + 1); return text.replace(/```json|```/g, ''); }

        // --- Save/Load System ---
        window.saveProject = () => {
            try {
                const blob = new Blob([JSON.stringify(appState, null, 2)], {type: "application/json"});
                const a = document.createElement("a");
                a.href = URL.createObjectURL(blob);
                a.download = `slr_project_${new Date().toISOString().slice(0,10)}.slr`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                updateStatus("Project saved.", "success");
            } catch (e) { alert("Save failed: " + e.message); }
        };

        window.downloadAuditLog = () => {
            try {
                const txt = `PRISMA-S AUDIT LOG\nGenerated: ${new Date().toISOString()}\n\n` + appState.auditLog.map(l => `[${l.timestamp}] ${l.action}: ${JSON.stringify(l.details)}`).join('\n\n');
                const a = document.createElement('a'); a.href = "data:text/plain;charset=utf-8," + encodeURIComponent(txt); a.download = "slr_audit_log.txt"; a.click();
            } catch(e) { alert("Audit Log download failed: " + e.message); }
        };

        window.loadProject = async (input) => {
            const file = input.files[0];
            if(!file) return;
            const text = await file.text();
            appState = JSON.parse(text);
            
            if(appState.articles.length > 0) {
                document.getElementById('input-panel').classList.add('hidden');
                document.getElementById('results-panel').classList.remove('hidden');
                renderResults();
                if(appState.articles.some(a=>a.FullTextFileName)) { document.getElementById('upload-panel').classList.remove('hidden'); renderFiles(); }
                if(appState.articles.some(a=>a.FinalDecision)) { document.getElementById('full-text-review-panel').classList.remove('hidden'); document.getElementById('report-panel').classList.remove('hidden'); renderFinalReviewResults(); }
            }
            updateStatus("Project loaded successfully.", "success");
        };

        async function fetchWithRetry(url, options = {}, retries = 4) {
            if (appState.abortProcessing) throw new Error("Aborted");
            for (let i = 0; i < retries; i++) {
                try {
                    const r = await fetch(url, options);
                    if (!r.ok) {
                        if (r.status === 401) { appState.abortProcessing = true; toggleModal('settings-modal'); throw new Error("API Key Error (401)"); }
                        if ((r.status === 429 || r.status === 503) && i < retries-1) { await new Promise(res => setTimeout(res, Math.pow(2,i)*1000)); continue; }
                        throw new Error(r.statusText);
                    }
                    return r;
                } catch (e) { if(appState.abortProcessing) throw e; if(i===retries-1) throw e; await new Promise(res => setTimeout(res, 1000)); }
            }
        }

        async function runWithConcurrency(tasks, limit) {
            const results = []; const executing = [];
            for (const task of tasks) {
                if (appState.abortProcessing) break;
                const p = Promise.resolve().then(() => task());
                results.push(p); const e = p.then(() => executing.splice(executing.indexOf(e), 1));
                executing.push(e);
                if (executing.length >= limit) await Promise.race(executing);
            }
            return Promise.all(results);
        }

        // --- 1. Import Logic ---
        function parseRIS(text) {
            const articles = []; const entries = text.split(/ER\s{0,2}-/g);
            entries.forEach(entry => {
                const getTag = (tag) => (entry.match(new RegExp(`${tag}\\s{1,2}-\\s+(.*)`)) || [])[1]?.trim();
                const title = getTag('TI') || getTag('T1');
                if (title) articles.push({ PMID: getTag('ID')||getTag('AN')||`RIS_${Math.random().toString(36).substr(2,9)}`, Title: title, Abstract: getTag('AB')||getTag('N2')||"No Abstract", Source: 'RIS Import', Decision: 'PENDING' });
            });
            return articles;
        }
        document.getElementById('ris-upload').addEventListener('change', async (e) => {
            const text = await e.target.files[0].text();
            const newArts = parseRIS(text);
            const unique = newArts.filter(n => !appState.articles.some(e => e.Title.toLowerCase().replace(/[^\w]/g,'') === n.Title.toLowerCase().replace(/[^\w]/g,'')));
            appState.articles.push(...unique);
            document.getElementById('total-articles-count').textContent = appState.articles.length;
            updateStatus(`Imported ${unique.length} articles (RIS).`, 'success');
            logAudit('RIS Import', { count: unique.length });
        });

        // --- 2. Protocol ---
        async function generateProtocol(e) {
            e.preventDefault();
            const q = document.getElementById('research-question').value;
            const limit = document.getElementById('max-results').value;
            
            setButtonLoading('generate-button', true);
            updateStatus('Drafting optimized protocol...', 'process');
            
            const prompt = `Act as a Systematic Reviewer. For question: "${q}", generate JSON: { "PICO": {"P":"...","I":"...","C":"...","O":"..."}, "Inclusion": "bullets", "Exclusion": "bullets", "SearchQuery": "((Sensitive OR Boolean) AND (Query OR MeSH))" }`;
            try {
                const res = await fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/${LLM_MODEL}:generateContent?key=${getApiKey()}`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ contents:[{parts:[{text:prompt}]}], generationConfig:{temperature:0.0} }) });
                const json = JSON.parse(extractJson((await res.json()).candidates[0].content.parts[0].text));
                
                document.getElementById('inclusion-criteria').value = JSON.stringify({Inclusion:json.Inclusion, Exclusion:json.Exclusion}, null, 2);
                appState.criteria = { Inclusion:json.Inclusion, Exclusion:json.Exclusion };
                if(json.PICO) ['p','i','c','o'].forEach(k => document.getElementById(`pico-${k}`).textContent = json.PICO[k.toUpperCase()]||'-');
                document.getElementById('pico-container').classList.remove('hidden');
                if(json.SearchQuery) document.getElementById('pubmed-query-input').value = json.SearchQuery;
                logAudit('Protocol Gen', json);

                if(appState.articles.length === 0 && json.SearchQuery) {
                    const uids = await fetchPubmedUids(json.SearchQuery, document.getElementById('date-limit').value, limit);
                    appState.articles = await fetchAbstracts(uids);
                    logAudit('PubMed Search', { count: appState.articles.length });
                }
                document.getElementById('total-articles-count').textContent = appState.articles.length;
                document.getElementById('review-panel').classList.remove('hidden');
                updateStatus(`Protocol Ready. ${appState.articles.length} articles loaded.`, 'success');
            } catch(e) { updateStatus('Error: '+e.message, 'error'); } finally { setButtonLoading('generate-button', false); }
        }

        // --- 3. Calibration & Screening ---
        window.startCalibration = () => {
            if(appState.articles.length < 5) return alert("Need 5+ articles.");
            appState.calibrationSet = appState.articles.sort(() => 0.5 - Math.random()).slice(0, 5);
            appState.calibrationIndex = 0; appState.humanVotes = {}; appState.aiVotes = {};
            document.getElementById('calibration-panel').classList.remove('hidden');
            document.getElementById('review-panel').classList.add('hidden');
            showCalibrationCard();
            runShadowAI(appState.calibrationSet); 
        };

        function showCalibrationCard() {
            const a = appState.calibrationSet[appState.calibrationIndex];
            document.getElementById('calib-content').innerHTML = `<h4 class="font-bold mb-2">${a.Title}</h4><p class="text-sm text-gray-600">${a.Abstract}</p>`;
        }

        window.calibVote = (v) => {
            appState.humanVotes[appState.calibrationSet[appState.calibrationIndex].PMID] = v;
            if(++appState.calibrationIndex < 5) showCalibrationCard(); else calculateKappa();
        };

        async function runShadowAI(articles) {
            const key = getApiKey();
            for(const a of articles) {
                const q = `Screen abstract. Criteria: ${JSON.stringify(appState.criteria)}. Article: ${a.Title} ${a.Abstract}. Output JSON: {"Decision": "INCLUDE" or "EXCLUDE"}`;
                try {
                    const res = await fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/${LLM_MODEL}:generateContent?key=${key}`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ contents:[{parts:[{text:q}]}] }) });
                    appState.aiVotes[a.PMID] = JSON.parse(extractJson((await res.json()).candidates[0].content.parts[0].text)).Decision;
                } catch(e){}
            }
        }

        function calculateKappa() {
            let agree = 0, n = 5;
            appState.calibrationSet.forEach(a => { if(appState.humanVotes[a.PMID] === (appState.aiVotes[a.PMID]||'EXCLUDE')) agree++; });
            const kappa = (agree/n).toFixed(2);
            document.getElementById('kappa-display').textContent = `Agreement: ${kappa * 100}%`;
            document.getElementById('calib-overlay').classList.remove('hidden');
            document.getElementById('calib-result-text').textContent = `Agreement: ${agree}/5. Proceed?`;
            logAudit('Calibration', { human: appState.humanVotes, ai: appState.aiVotes });
        }

        window.finishCalibration = () => { document.getElementById('calibration-panel').classList.add('hidden'); window.startScreening({skip:true}); };

        // --- 4. Dual Agent Screening ---
        window.startScreening = async () => {
            appState.criteria = JSON.parse(document.getElementById('inclusion-criteria').value);
            document.getElementById('review-panel').classList.add('hidden');
            updateStatus(`Dual-Agent Screening ${appState.articles.length} articles...`, 'process');
            
            const toScreen = appState.articles.filter(a => !appState.humanVotes[a.PMID]);
            let done = 0;
            setProgressBar(0, `Screening: 0/${toScreen.length}`);

            const tasks = toScreen.map(article => async () => {
                const res = await screenDual(article);
                done++;
                setProgressBar(Math.round((done/toScreen.length)*100), `Screening: ${done}/${toScreen.length}`);
                return { ...article, ...res };
            });
            
            appState.articles = await runWithConcurrency(tasks, CONCURRENCY_LIMIT);
            setProgressBar(null); 
            renderResults();
            updateStatus('Screening Complete', 'success');
            logAudit('Screening', { count: appState.articles.length });
        };

        async function screenDual(article) {
            const key = getApiKey();
            const promptA = `Role: Reviewer A (Sensitive). Include if potentially relevant. Criteria: ${JSON.stringify(appState.criteria)}. Article: ${article.Title} ${article.Abstract}. Output JSON: {"Decision": "INCLUDE"|"EXCLUDE", "Reasoning": "brief"}`;
            const promptB = `Role: Reviewer B (Strict). Include only if perfect match. Criteria: ${JSON.stringify(appState.criteria)}. Article: ${article.Title} ${article.Abstract}. Output JSON: {"Decision": "INCLUDE"|"EXCLUDE", "Reasoning": "brief"}`;
            
            try {
                const [rA, rB] = await Promise.all([
                    fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/${LLM_MODEL}:generateContent?key=${key}`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ contents:[{parts:[{text:promptA}]}] }) }),
                    fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/${LLM_MODEL}:generateContent?key=${key}`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ contents:[{parts:[{text:promptB}]}] }) })
                ]);
                const jA = JSON.parse(extractJson((await rA.json()).candidates[0].content.parts[0].text));
                const jB = JSON.parse(extractJson((await rB.json()).candidates[0].content.parts[0].text));
                
                let d = 'EXCLUDE', conflict = false;
                if(jA.Decision === 'INCLUDE' && jB.Decision === 'INCLUDE') d = 'INCLUDE';
                else if(jA.Decision !== jB.Decision) { d = 'NEEDS_REVIEW'; conflict = true; }
                
                return { Decision: d, Conflict: conflict, Reasoning: `A: ${jA.Reasoning} | B: ${jB.Reasoning}`, Reviewers: {A:jA, B:jB} };
            } catch(e) { return { Decision: 'ERROR', Reasoning: 'API Fail' }; }
        }

        function renderResults() {
            document.getElementById('results-panel').classList.remove('hidden');
            document.getElementById('upload-panel').classList.remove('hidden');
            const inc = appState.articles.filter(a => a.Decision === 'INCLUDE' && !a.Conflict);
            const con = appState.articles.filter(a => a.Conflict || a.Decision === 'NEEDS_REVIEW');
            const exc = appState.articles.filter(a => a.Decision === 'EXCLUDE');
            
            document.getElementById('included-count').textContent = inc.length;
            document.getElementById('borderline-count').textContent = con.length;
            document.getElementById('excluded-count').textContent = exc.length;
            
            const mkCard = (a, type) => `<div class="article-card bg-white p-4 rounded border-l-4 ${type==='inc'?'border-green-500':(type==='con'?'border-yellow-500':'border-gray-300')}">
                <h4 class="font-bold text-sm">${a.Title}</h4><p class="text-xs text-gray-600 mt-1 line-clamp-3">${a.Abstract}</p>
                ${type==='con' ? `<div class="mt-2 text-xs bg-yellow-50 p-1 rounded">ü§ñ A: ${a.Reviewers?.A.Decision} | B: ${a.Reviewers?.B.Decision}</div>
                <div class="mt-2 flex gap-2"><button onclick="window.resolve('${a.PMID}','INCLUDE')" class="bg-green-100 px-2 py-1 rounded text-xs font-bold">Include</button><button onclick="window.resolve('${a.PMID}','EXCLUDE')" class="bg-red-100 px-2 py-1 rounded text-xs font-bold">Exclude</button></div>` : ''}
                <div class="mt-2 text-xs italic text-gray-500">${a.Reasoning}</div>
            </div>`;
            
            document.getElementById('included-list').innerHTML = inc.map(a=>mkCard(a,'inc')).join('');
            document.getElementById('borderline-list').innerHTML = con.map(a=>mkCard(a,'con')).join('');
            document.getElementById('excluded-list').innerHTML = exc.map(a=>mkCard(a,'exc')).join('');
            
            if(inc.length > 0) {
                const toFetch = inc.filter(a => a.PMCID && !a.FullTextFileName);
                if(toFetch.length > 0) attemptFullTextRetrieval();
                renderFiles();
            }
            if(con.length > 0) switchTab('borderline'); else switchTab('included');
        }

        window.resolve = (pmid, dec) => {
            const idx = appState.articles.findIndex(a => a.PMID === pmid);
            if(idx !== -1) { appState.articles[idx].Decision = dec; appState.articles[idx].Conflict = false; appState.articles[idx].Override = true; renderResults(); }
        };

        // --- 5. Full Text & Extraction ---
        async function attemptFullTextRetrieval() {
            const list = appState.articles.filter(a => a.Decision === 'INCLUDE' && !a.Conflict && a.PMCID && !a.FullTextFileName).slice(0, 10);
            if(list.length === 0) return;
            document.getElementById('retrieval-status-message').innerHTML = "Fetching PMC texts...";
            document.getElementById('retrieval-status-message').classList.remove('hidden');
            let done = 0;
            setProgressBar(0, `Downloading Full Text: 0/${list.length}`);
            const tasks = list.map(a => async () => {
                try {
                    const r = await fetch(`${PUBMED_BASE_URL}efetch.fcgi?db=pmc&id=${a.PMCID}&retmode=text&rettype=full&tool=${API_TOOL}&email=${API_EMAIL}`);
                    const t = await r.text();
                    if(!t.includes('error') && t.length > 500) { appState.uploadedTexts[`AUTO_${a.PMCID}.txt`] = t; a.FullTextFileName = `AUTO_${a.PMCID}.txt`; }
                } catch(e){}
                done++;
                setProgressBar(Math.round((done/list.length)*100), `Downloading Full Text: ${done}/${list.length}`);
            });
            await runWithConcurrency(tasks, 4);
            setProgressBar(null);
            document.getElementById('retrieval-status-message').innerHTML = "PMC Fetch Complete.";
            renderFiles();
        }

        function renderFiles() {
            const inc = appState.articles.filter(a => a.Decision === 'INCLUDE' && !a.Conflict);
            document.getElementById('fileListContainer').innerHTML = inc.map(a => `<div class="flex justify-between text-sm border-b py-1"><span>${a.Title.substring(0,50)}...</span><span class="${a.FullTextFileName?'text-green-600':'text-red-500'}">${a.FullTextFileName?'Ready':'Missing'}</span></div>`).join('');
            const btn = document.getElementById('start-full-text-review-button');
            if(inc.some(a => a.FullTextFileName)) { btn.disabled = false; btn.classList.remove('opacity-50', 'cursor-not-allowed'); }
        }

        window.handleFileSelect = async () => {
            const files = document.getElementById('fileInput').files;
            for(const f of files) {
                appState.uploadedTexts[f.name] = await f.text(); 
                const match = appState.articles.find(a => f.name.includes(a.PMID));
                if(match) match.FullTextFileName = f.name;
            }
            renderFiles();
        };

        window.startFullTextReview = async () => {
            setButtonLoading('start-full-text-review-button', true);
            document.getElementById('full-text-review-panel').classList.remove('hidden');
            const toReview = appState.articles.filter(a => a.Decision === 'INCLUDE' && !a.Conflict && a.FullTextFileName);
            
            // Get Custom Fields
            const fields = document.getElementById('extraction-fields').value.split(',').map(s=>s.trim()).filter(s=>s);
            appState.extractionSchema = fields;

            let done = 0;
            setProgressBar(0, `Analyzing Full Text: 0/${toReview.length}`);

            const tasks = toReview.map(a => async () => {
                const txt = appState.uploadedTexts[a.FullTextFileName].substring(0, 15000);
                const q = `Analyze full text. Criteria: ${JSON.stringify(appState.criteria)}. Text: ${txt}. 
                Tasks:
                1. Decide Final Inclusion based on full text.
                2. Extract these specific fields: ${JSON.stringify(fields)}
                3. Assess Risk of Bias.
                Output JSON: { "FinalDecision": "INCLUDE"|"EXCLUDE", "Data": { ...fields... }, "RiskOfBias": {"Selection":"Low/High","Blinding":"Low/High"} }`;
                try {
                    const res = await fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/${LLM_MODEL}:generateContent?key=${getApiKey()}`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ contents:[{parts:[{text:q}]}] }) });
                    a.ExtractedData = JSON.parse(extractJson((await res.json()).candidates[0].content.parts[0].text));
                    a.FinalDecision = a.ExtractedData.FinalDecision;
                } catch(e){ a.FinalDecision = 'ERROR'; }
                done++; 
                setProgressBar(Math.round((done/toReview.length)*100), `Analyzing Full Text: ${done}/${toReview.length}`);
            });
            await runWithConcurrency(tasks, 4);
            setProgressBar(null);
            renderFinalReviewResults();
            document.getElementById('report-panel').classList.remove('hidden');
            setButtonLoading('start-full-text-review-button', false);
        };

        function renderFinalReviewResults() {
            const list = document.getElementById('extraction-table-body');
            list.innerHTML = appState.articles.filter(a => a.FinalDecision).map(a => {
                const dataCells = appState.extractionSchema.map(f => `<div class="mb-1"><span class="font-bold text-[10px] text-gray-500 uppercase">${f}:</span> ${a.ExtractedData?.Data?.[f] || 'N/A'}</div>`).join('');
                return `<tr class="border-b hover:bg-gray-50">
                    <td class="p-2 font-mono">${a.PMID}</td>
                    <td class="p-2 font-bold ${a.FinalDecision==='INCLUDE'?'text-green-600':'text-red-500'}">${a.FinalDecision}</td>
                    <td class="p-2">${dataCells}</td>
                    <td class="p-2 text-[10px]">${JSON.stringify(a.ExtractedData?.RiskOfBias || {}).substring(0,50)}...</td>
                </tr>`;
            }).join('');
        }

        // --- 6. Report Generation & Refinement ---
        document.getElementById('generate-report-button').addEventListener('click', async () => {
            setButtonLoading('generate-report-button', true);
            updateStatus('Generating Report...', 'process');
            try {
                // FIXED: FALLBACK LOGIC IF FULL TEXT SKIPPED
                const inc = appState.articles.filter(a => a.FinalDecision === 'INCLUDE' || (!a.FinalDecision && a.Decision === 'INCLUDE' && !a.Conflict));
                
                if (inc.length === 0) {
                    document.getElementById('slr-draft-output').innerHTML = "No included articles found.";
                    updateStatus("Report Error: No Included Articles", "error");
                    setButtonLoading('generate-report-button', false);
                    return;
                }
                
                // Detailed data for citations and GRADE
                const promptData = inc.map(a => ({
                    AuthorYear: `${a.Title.split(' ')[0]} et al. (${a.Year || '2023'})`, // Fallback, updated parsing below would be better
                    Title: a.Title,
                    CitationMeta: a.CitationMeta || { Year: a.Year || '2023', Journal: 'PubMed Source' }, // Fallback meta
                    Details: a.ExtractedData?.Data || a.Reasoning || a.Abstract.substring(0, 500)
                }));

                const prompt = `Write a Systematic Literature Review.
                1. Structure: Introduction, Methods, Results, Discussion.
                2. Include a "Summary of Findings" table assessing certainty of evidence (GRADE style: High/Mod/Low).
                3. Use in-text citations like [1], [2].
                4. At the very end, generate a "References" section. Use the 'CitationMeta' to create a formatted bibliography (APA).
                
                Included Studies: ${JSON.stringify(promptData)}.`;

                const res = await fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/${LLM_MODEL}:generateContent?key=${getApiKey()}`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ contents:[{parts:[{text:prompt}]}] }) });
                const reportText = (await res.json()).candidates[0].content.parts[0].text;
                appState.currentDraft = reportText;
                document.getElementById('slr-draft-output').innerHTML = reportText.replace(/\n/g, '<br>');
                document.getElementById('refine-section').classList.remove('hidden');
                updateStatus('Report Generated', 'success');
            } catch(e) { updateStatus('Report Error: ' + e.message, 'error'); } 
            finally { setButtonLoading('generate-report-button', false); }
        });

        document.getElementById('refine-button').addEventListener('click', async () => {
            const btn = document.getElementById('refine-button');
            const originalText = btn.innerText;
            btn.innerText = "Refining..."; btn.disabled = true;
            const instructions = document.getElementById('refine-instructions').value;
            const prompt = `Rewrite this draft based on instructions: "${instructions}".\n\nDRAFT:\n${appState.currentDraft}`;
            try {
                const res = await fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/${LLM_MODEL}:generateContent?key=${getApiKey()}`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ contents:[{parts:[{text:prompt}]}] }) });
                const newText = (await res.json()).candidates[0].content.parts[0].text;
                appState.currentDraft = newText;
                document.getElementById('slr-draft-output').innerHTML = newText.replace(/\n/g, '<br>');
                updateStatus('Report Refined', 'success');
            } catch(e) { updateStatus('Refine Error', 'error'); } 
            finally { btn.innerText = originalText; btn.disabled = false; }
        });

        // --- Helpers ---
        window.skipFullTextReview = () => { document.getElementById('report-panel').classList.remove('hidden'); };
        
        window.generatePrismaDiagram = () => {
            // Robust check to prevent crash if appState.articles is empty
            if (!appState.articles || appState.articles.length === 0) {
                document.getElementById('prisma-output').innerHTML = "<p class='text-red-500'>No data to generate diagram.</p>";
                return;
            }

            const total = appState.articles.length;
            const incAbstract = appState.articles.filter(a => a.Decision === 'INCLUDE' && !a.Conflict).length;
            const excAbstract = appState.articles.filter(a => a.Decision === 'EXCLUDE').length;
            const incFull = appState.articles.filter(a => a.FinalDecision === 'INCLUDE').length;
            const finalInc = incFull > 0 ? incFull : incAbstract; 
            
            const svg = `<svg width="600" height="500" viewBox="0 0 600 500" xmlns="http://www.w3.org/2000/svg" font-family="sans-serif" font-size="12">
                <rect x="200" y="20" width="200" height="60" fill="#eff6ff" stroke="#2563eb" stroke-width="2"/>
                <text x="300" y="55" text-anchor="middle" font-weight="bold">Identification: ${total} records</text>
                <line x1="300" y1="80" x2="300" y2="120" stroke="#333" stroke-width="2" marker-end="url(#arrow)"/>
                <rect x="200" y="120" width="200" height="60" fill="#eff6ff" stroke="#2563eb" stroke-width="2"/>
                <text x="300" y="155" text-anchor="middle" font-weight="bold">Screened: ${total}</text>
                <line x1="400" y1="150" x2="450" y2="150" stroke="#333" stroke-width="2"/>
                <text x="455" y="155" fill="#b91c1c">Excluded: ${excAbstract}</text>
                <line x1="300" y1="180" x2="300" y2="220" stroke="#333" stroke-width="2"/>
                <rect x="200" y="220" width="200" height="60" fill="#f5f3ff" stroke="#7c3aed" stroke-width="2"/>
                <text x="300" y="255" text-anchor="middle" font-weight="bold">Full Text: ${incAbstract}</text>
                <line x1="300" y1="280" x2="300" y2="320" stroke="#333" stroke-width="2"/>
                <rect x="200" y="320" width="200" height="60" fill="#ecfdf5" stroke="#059669" stroke-width="2"/>
                <text x="300" y="355" text-anchor="middle" font-weight="bold">Included: ${finalInc}</text>
            </svg>`;
            document.getElementById('prisma-output').innerHTML = svg;
        };

        window.exportResults = (format) => {
            const articles = appState.articles;
            if (format === 'json') {
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(articles, null, 2));
                const a = document.createElement('a'); a.href = dataStr; a.download = "slr_results.json"; a.click();
            } else if (format === 'csv') {
                // Dynamic CSV based on extraction schema
                const extractionHeaders = appState.extractionSchema || [];
                const headers = ["PMID", "Title", "AbstractDecision", "FinalDecision", ...extractionHeaders, "RiskOfBias"];
                const rows = articles.map(a => [
                    a.PMID,
                    `"${(a.Title || '').replace(/"/g, '""')}"`,
                    a.Decision,
                    a.FinalDecision || 'N/A',
                    ...extractionHeaders.map(f => `"${(a.ExtractedData?.Data?.[f] || '').replace(/"/g, '""')}"`),
                    `"${JSON.stringify(a.ExtractedData?.RiskOfBias || {}).replace(/"/g, '""')}"`
                ]);
                const csvContent = "data:text/csv;charset=utf-8," + [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
                const a = document.createElement('a'); a.href = encodeURI(csvContent); a.download = "slr_results.csv"; a.click();
            }
        }

        async function fetchPubmedUids(q, d, limit) { 
            let u = `${PUBMED_BASE_URL}esearch.fcgi?db=pubmed&term=${encodeURIComponent(q)}&retmax=${limit}&retmode=json`; 
            if(d) u+=`&mindate=${d}&maxdate=2025&datetype=pdat`; 
            return (await (await fetch(u)).json()).esearchresult?.idlist||[]; 
        }

        async function fetchAbstracts(ids) { 
            if(!ids.length) return [];
            const CHUNK_SIZE = 50; 
            let allArts = [];
            for(let i=0; i<ids.length; i+=CHUNK_SIZE) {
                const chunk = ids.slice(i, i+CHUNK_SIZE);
                const t = await (await fetch(`${PUBMED_BASE_URL}efetch.fcgi?db=pubmed&id=${chunk.join(',')}&retmode=xml&rettype=abstract`)).text(); 
                const x = new DOMParser().parseFromString(t,"text/xml"); 
                const batch = Array.from(x.querySelectorAll('PubmedArticle')).map(a=>({
                    PMID:a.querySelector('PMID')?.textContent, 
                    Title:a.querySelector('ArticleTitle')?.textContent, 
                    Abstract:a.querySelector('AbstractText')?.textContent||'No Abstract', 
                    PMCID:a.querySelector('ArticleId[IdType="pmc"]')?.textContent, 
                    Decision:'PENDING',
                    // NEW: Metadata extraction
                    Year: a.querySelector('PubDate Year')?.textContent || '2023',
                    CitationMeta: {
                        Journal: a.querySelector('Title')?.textContent || a.querySelector('ISOAbbreviation')?.textContent || 'Journal',
                        Volume: a.querySelector('Volume')?.textContent || '',
                        Issue: a.querySelector('Issue')?.textContent || '',
                        Pages: a.querySelector('MedlinePgn')?.textContent || '',
                        Authors: Array.from(a.querySelectorAll('Author')).map(auth => {
                            const last = auth.querySelector('LastName')?.textContent;
                            const init = auth.querySelector('Initials')?.textContent;
                            return last ? `${last} ${init}` : null;
                        }).filter(n=>n).join(', ')
                    }
                }));
                allArts = allArts.concat(batch);
            }
            return allArts;
        }

        document.getElementById('criteria-form').addEventListener('submit', generateProtocol);
        const k = localStorage.getItem('custom_api_key'); if(k) document.getElementById('api-key-input').value = k;
        
        // Checklist logic
        window.checkPrisma = () => {
            const checks = [
                {text:"Rationale described?", val: !!appState.currentDraft},
                {text:"Search strategy provided?", val: !!appState.criteria.Inclusion},
                {text:"Selection process specified?", val: true},
                {text:"Data items listed?", val: appState.extractionSchema.length > 0},
                {text:"Risk of bias assessment?", val: appState.articles.some(a=>a.ExtractedData?.RiskOfBias)}
            ];
            document.getElementById('prisma-list').innerHTML = checks.map(c => 
                `<div class="flex items-center justify-between p-2 border-b"><span class="${c.val?'text-green-700':'text-red-600'} font-bold">${c.val?'‚úî':'‚úñ'}</span> <span>${c.text}</span></div>`
            ).join('');
            toggleModal('prisma-modal');
        };
    </script>
</body>
</html>
