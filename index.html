<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI-Assisted SLR Screener (Improved)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
        .scroll-container { max-height: 70vh; overflow-y: auto; border: 1px solid #e5e7eb; background-color: white; padding: 1rem; }
        .article-card { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); transition: transform 0.2s; }
        .article-card:hover { transform: translateY(-2px); }
        #slr-draft-output { white-space: pre-wrap; font-family: 'Inter', sans-serif; }
        #slr-draft-output h1, #slr-draft-output h2, #slr-draft-output h3 { font-weight: bold; margin-top: 1.5rem; margin-bottom: 0.5rem; border-bottom: 1px solid #ddd; }
        #slr-draft-output h1 { font-size: 2rem; } #slr-draft-output h2 { font-size: 1.5rem; } #slr-draft-output h3 { font-size: 1.25rem; }
        .file-upload-label { cursor: pointer; transition: all 0.3s ease; }
        .file-upload-label:hover { box-shadow: 0 4px 15px -3px rgba(59, 130, 246, 0.5); transform: translateY(-1px); }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .progress-bar { transition: width 0.3s ease; }
    </style>
</head>
<body>
    <div class="max-w-6xl mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-8 p-6 bg-white rounded-xl shadow-lg">
            <h1 class="text-4xl font-extrabold text-blue-800">AI-Assisted SLR Screener</h1>
            <p class="text-lg text-gray-600 mt-2">Automate screening using PubMed and Gemini AI</p>
            <div class="mt-4">
                <label for="api-key-input" class="block text-sm font-medium text-gray-700 mb-2">Gemini API Key (Required):</label>
                <input type="password" id="api-key-input" class="w-full max-w-md mx-auto p-2 border border-gray-300 rounded-lg" placeholder="Enter your API key">
                <p class="text-xs text-gray-500 mt-1">Get free key at <a href="https://makersuite.google.com/app/apikey" target="_blank" class="text-blue-600 hover:underline">Google AI Studio</a></p>
            </div>
        </header>

        <div id="progress-container" class="bg-white p-4 rounded-xl shadow-lg mb-4 hidden">
            <div class="flex justify-between items-center mb-2">
                <span class="text-sm font-medium" id="progress-text">Processing...</span>
                <span class="text-sm font-medium" id="progress-percentage">0%</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2.5">
                <div class="progress-bar bg-blue-600 h-2.5 rounded-full" id="progress-bar" style="width: 0%"></div>
            </div>
            <button id="cancel-btn" class="mt-2 px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 text-sm hidden">Cancel</button>
        </div>

        <div id="status-message" class="text-center text-lg font-medium py-4 rounded-lg shadow-inner hidden"></div>

        <div id="input-panel" class="bg-white p-6 rounded-xl shadow-lg mb-8">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">1. Research Question</h2>
            <form id="criteria-form">
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Research Question:</label>
                    <textarea id="research-question" rows="4" required class="w-full p-3 border rounded-lg" placeholder="What is the impact of LLMs on medical education?">What is the impact of large language models on medical education curricula?</textarea>
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Date Limit (Optional):</label>
                    <input type="number" id="date-limit" min="1900" max="2099" class="w-full p-3 border rounded-lg" placeholder="e.g., 2023">
                </div>
                <button type="submit" id="generate-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg">Generate Criteria</button>
            </form>
        </div>

        <div id="review-panel" class="bg-white p-6 rounded-xl shadow-lg mb-8 hidden">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">2. Review Criteria</h2>
            <form id="screening-form">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">PubMed Query:</label>
                    <input type="text" id="pubmed-query" required class="w-full p-3 border rounded-lg">
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Criteria (JSON):</label>
                    <textarea id="inclusion-criteria" rows="6" required class="w-full p-3 border rounded-lg font-mono text-sm"></textarea>
                </div>
                <button type="submit" id="start-screening-button" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg">Start Screening</button>
            </form>
        </div>

        <div id="results-panel" class="hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b-4 border-blue-200 pb-2">3. Screening Results</h2>
            <div class="mb-8">
                <h3 class="text-2xl font-semibold text-green-700 mb-3">Included (<span id="included-count">0</span>)</h3>
                <div id="included-list" class="scroll-container grid gap-4 grid-cols-1 md:grid-cols-2"></div>
            </div>
            <div>
                <h3 class="text-2xl font-semibold text-red-600 mb-3">Excluded (<span id="excluded-count">0</span>)</h3>
                <div id="excluded-list" class="scroll-container grid gap-4 grid-cols-1 md:grid-cols-2"></div>
            </div>
            <button onclick="window.exportResults()" class="mt-8 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg">Export Results</button>
        </div>

        <div id="upload-panel" class="bg-white p-6 rounded-xl shadow-lg mt-8 hidden">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">4. Upload Full Texts</h2>
            <div id="retrieval-status-message" class="mb-4 p-3 rounded-lg hidden"></div>
            <input type="file" id="fileInput" accept=".txt,.md,.log,.csv" multiple class="hidden">
            <label for="fileInput" class="file-upload-label flex flex-col items-center justify-center p-8 border-4 border-purple-500 rounded-lg bg-purple-100 text-purple-700 hover:bg-purple-200">
                <span class="text-lg font-semibold">Click to upload files (PMID in filename)</span>
            </label>
            <button id="start-full-text-review-button" class="hidden mt-4 w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg">Start Full Text Review</button>
            <div id="fileListContainer" class="mt-4 space-y-4">
                <p id="initialMessage" class="text-center text-gray-500 italic">Files will appear here</p>
            </div>
        </div>

        <div id="full-text-review-panel" class="bg-white p-6 rounded-xl shadow-lg mt-8 hidden">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">5. Full Text Results</h2>
            <div id="final-review-list" class="scroll-container grid gap-4 grid-cols-1 md:grid-cols-2"></div>
        </div>

        <div id="report-panel" class="bg-white p-6 rounded-xl shadow-lg mt-8 hidden">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">6. Generate Report</h2>
            <textarea id="drafting-instructions" rows="2" class="w-full p-3 border rounded-lg mb-4" placeholder="Optional instructions..."></textarea>
            <button id="generate-report-button" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg">Generate Draft</button>
            <div id="slr-draft-output" class="mt-6 p-4 border rounded-lg bg-gray-50 max-h-[50vh] overflow-y-auto"></div>
        </div>

        <div id="modification-panel" class="bg-white p-6 rounded-xl shadow-lg mt-8 hidden">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">7. Modify Draft</h2>
            <textarea id="modification-request" rows="3" class="w-full p-3 border rounded-lg mb-4" placeholder="Modification request..."></textarea>
            <button id="refine-report-button" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 px-4 rounded-lg">Refine</button>
        </div>

        <div id="prisma-panel" class="bg-white p-6 rounded-xl shadow-lg mt-8 hidden">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">8. PRISMA Diagram</h2>
            <button onclick="window.generatePrismaDiagram()" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded-lg">Generate Diagram</button>
            <div id="prisma-output" class="mt-6 p-4 rounded-lg bg-white overflow-x-auto text-center"></div>
        </div>
    </div>

    <script type="module">
        const LLM_MODEL = "gemini-2.0-flash-exp";
        const PUBMED_BASE = 'https://eutils.ncbi.nlm.nih.gov/entrez/eutils/';
        const BATCH_SIZE = 10;
        const MAX_TEXT = 5000;
        let cancelOp = false;

        const state = { articles: [], criteria: {}, pubmedQuery: '', dateLimit: null, currentDraft: '', uploadedTexts: {} };
        const SPINNER = '<svg class="animate-spin inline-block h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';

        function getKey() {
            const k = document.getElementById('api-key-input').value.trim();
            if (!k) throw new Error('Enter API key');
            return k;
        }

        function setLoading(id, loading) {
            const btn = document.getElementById(id);
            if (!btn) return;
            if (loading) {
                btn.setAttribute('data-text', btn.textContent);
                btn.disabled = true;
                btn.innerHTML = SPINNER + ' Working...';
            } else {
                btn.disabled = false;
                btn.innerHTML = btn.getAttribute('data-text') || 'Start';
            }
        }

        function updateProgress(cur, tot, txt = 'Processing') {
            const cont = document.getElementById('progress-container');
            const bar = document.getElementById('progress-bar');
            const pct = document.getElementById('progress-percentage');
            const ptxt = document.getElementById('progress-text');
            const cbtn = document.getElementById('cancel-btn');
            
            if (cur === 0 && tot === 0) {
                cont.classList.add('hidden');
                cbtn.classList.add('hidden');
                return;
            }
            
            cont.classList.remove('hidden');
            cbtn.classList.remove('hidden');
            const p = Math.round((cur / tot) * 100);
            bar.style.width = p + '%';
            pct.textContent = p + '%';
            ptxt.textContent = `${txt} (${cur}/${tot})`;
        }

        async function fetchRetry(url, opts = {}, retries = 3) {
            for (let i = 0; i < retries; i++) {
                if (cancelOp) throw new Error('Cancelled');
                try {
                    const r = await fetch(url, opts);
                    if (!r.ok) {
                        if (r.status === 429 && i < retries - 1) {
                            await new Promise(res => setTimeout(res, Math.pow(2, i) * 1000));
                            continue;
                        }
                        throw new Error(`API Error: ${r.status}`);
                    }
                    return r;
                } catch (e) {
                    if (i === retries - 1) throw e;
                    await new Promise(res => setTimeout(res, Math.pow(2, i) * 1000));
                }
            }
        }

        function updateStatus(msg, type = 'info') {
            const el = document.getElementById('status-message');
            el.innerHTML = (type === 'process' ? SPINNER + ' ' : '') + msg;
            el.className = 'text-center text-lg font-medium py-4 rounded-xl shadow-md mt-4';
            el.classList.remove('hidden', 'bg-red-100', 'text-red-800', 'bg-green-100', 'text-green-800', 'bg-yellow-100', 'text-yellow-800', 'bg-blue-100', 'text-blue-800');
            if (type === 'error') el.classList.add('bg-red-100', 'text-red-800');
            else if (type === 'success') el.classList.add('bg-green-100', 'text-green-800');
            else if (type === 'process') el.classList.add('bg-blue-100', 'text-blue-800');
            else el.classList.add('bg-yellow-100', 'text-yellow-800');
            el.classList.remove('hidden');
        }

        async function callGemini(sys, usr, schema = null) {
            const key = getKey();
            const payload = {
                contents: [{ parts: [{ text: usr }] }],
                systemInstruction: { parts: [{ text: sys }] }
            };
            if (schema) payload.generationConfig = { responseMimeType: "application/json", responseSchema: schema };
            
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${LLM_MODEL}:generateContent?key=${key}`;
            const r = await fetchRetry(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            const data = await r.json();
            if (data.error) throw new Error(data.error.message);
            const content = data.candidates?.[0]?.content?.parts?.[0]?.text;
            if (!content) throw new Error("Empty response");
            return schema ? JSON.parse(content) : content;
        }

        async function generateCriteria(question) {
            setLoading('generate-button', true);
            updateStatus('Generating criteria...', 'process');
            
            try {
                const result = await callGemini(
                    'You are a systematic review expert. Generate inclusion/exclusion criteria and a PubMed query.',
                    `Research Question: ${question}\n\nOutput JSON with: Inclusion, Exclusion, SuggestedPubmedQuery`,
                    { type: "OBJECT", properties: { Inclusion: {type: "STRING"}, Exclusion: {type: "STRING"}, SuggestedPubmedQuery: {type: "STRING"} }, required: ["Inclusion", "Exclusion", "SuggestedPubmedQuery"] }
                );
                setLoading('generate-button', false);
                updateStatus('Criteria generated!', 'success');
                return result;
            } catch (e) {
                setLoading('generate-button', false);
                updateStatus('Error: ' + e.message, 'error');
                return null;
            }
        }

        async function fetchPubMed(query, dateLimit) {
            updateStatus('Searching PubMed...', 'process');
            let url = `${PUBMED_BASE}esearch.fcgi?db=pubmed&term=${encodeURIComponent(query)}&retmax=100000&retmode=json`;
            if (dateLimit) {
                const yr = new Date().getFullYear();
                url += `&mindate=${dateLimit}&maxdate=${yr}&datetype=pdat`;
            }
            const r = await fetchRetry(url);
            const data = await r.json();
            const uids = data.esearchresult?.idlist || [];
            updateStatus(`Found ${uids.length} articles`, 'process');
            return uids;
        }

        async function fetchAbstracts(uids) {
            if (!uids.length) return [];
            const all = [];
            for (let i = 0; i < uids.length; i += 500) {
                if (cancelOp) break;
                const chunk = uids.slice(i, i + 500);
                updateStatus(`Fetching abstracts ${i + 1}-${Math.min(i + 500, uids.length)}...`, 'process');
                const url = `${PUBMED_BASE}efetch.fcgi?db=pubmed&id=${chunk.join(',')}&retmode=xml&rettype=abstract`;
                const r = await fetchRetry(url);
                const txt = await r.text();
                const parser = new DOMParser();
                const xml = parser.parseFromString(txt, "application/xml");
                xml.querySelectorAll('PubmedArticle').forEach(art => {
                    const pmid = art.querySelector('PMID')?.textContent;
                    const title = art.querySelector('ArticleTitle')?.textContent;
                    const abs = art.querySelector('AbstractText')?.textContent;
                    let pmcid = null;
                    art.querySelectorAll('ArticleId').forEach(id => {
                        if (id.getAttribute('IdType') === 'pmc') pmcid = id.textContent;
                    });
                    if (pmid && title) {
                        all.push({ PMID: pmid, Title: title, Abstract: abs || 'No abstract', PMCID: pmcid, Decision: 'PENDING', Category: 'PENDING', Reasoning: 'Pending', Override: false, FullTextFileName: null });
                    }
                });
            }
            return all;
        }

        async function screenArticle(art, crit) {
            try {
                const result = await callGemini(
                    'You are a systematic review expert. Screen this article.',
                    `PMID: ${art.PMID}\nTitle: ${art.Title}\nAbstract: ${art.Abstract}\n\nInclusion: ${crit.Inclusion}\nExclusion: ${crit.Exclusion}\n\nOutput JSON with: Decision (INCLUDE/EXCLUDE), Category, Reasoning`,
                    { type: "OBJECT", properties: { Decision: {type: "STRING", enum: ["INCLUDE", "EXCLUDE"]}, Category: {type: "STRING"}, Reasoning: {type: "STRING"} }, required: ["Decision", "Category", "Reasoning"] }
                );
                return { ...result, Override: false };
            } catch (e) {
                return { Decision: 'ERROR', Category: 'ERROR', Reasoning: e.message, Override: false };
            }
        }

        async function reviewFullText(art, crit, txt) {
            const trunc = txt.substring(0, MAX_TEXT);
            try {
                const result = await callGemini(
                    'Review this full text against criteria.',
                    `PMID: ${art.PMID}\nCriteria:\nInclusion: ${crit.Inclusion}\nExclusion: ${crit.Exclusion}\n\nFull Text:\n${trunc}\n\nOutput JSON with: FinalDecision (FINAL_INCLUDE/FINAL_EXCLUDE), FinalReasoning`,
                    { type: "OBJECT", properties: { FinalDecision: {type: "STRING", enum: ["FINAL_INCLUDE", "FINAL_EXCLUDE"]}, FinalReasoning: {type: "STRING"} }, required: ["FinalDecision", "FinalReasoning"] }
                );
                return result;
            } catch (e) {
                return { FinalDecision: 'ERROR', FinalReasoning: e.message };
            }
        }

        async function fetchPMC(pmcid) {
            try {
                const url = `${PUBMED_BASE}efetch.fcgi?db=pmc&id=${pmcid}&retmode=text&rettype=full`;
                const r = await fetchRetry(url);
                const txt = await r.text();
                if (txt.includes("cannot be found") || txt.length < 100) return null;
                return txt;
            } catch (e) {
                return null;
            }
        }

        async function autoRetrieve() {
            const arts = state.articles.filter(a => ((a.Decision === 'INCLUDE' && !a.Override) || a.Override) && a.PMCID && !a.FullTextFileName);
            if (!arts.length) {
                document.getElementById('retrieval-status-message').innerHTML = 'No PMC articles found';
                document.getElementById('retrieval-status-message').classList.remove('hidden');
                return;
            }
            
            document.getElementById('retrieval-status-message').innerHTML = SPINNER + ` Retrieving ${arts.length} articles...`;
            document.getElementById('retrieval-status-message').classList.remove('hidden');
            
            let success = 0;
            for (let i = 0; i < arts.length; i++) {
                if (cancelOp) break;
                updateProgress(i + 1, arts.length, 'Retrieving');
                const txt = await fetchPMC(arts[i].PMCID);
                if (txt) {
                    const fn = `AUTO_PMC_${arts[i].PMCID}_(PMID_${arts[i].PMID}).txt`;
                    state.uploadedTexts[fn] = txt;
                    const idx = state.articles.findIndex(a => a.PMID === arts[i].PMID);
                    if (idx !== -1) state.articles[idx].FullTextFileName = fn;
                    success++;
                }
                await new Promise(r => setTimeout(r, 500));
            }
            
            updateProgress(0, 0);
            document.getElementById('retrieval-status-message').innerHTML = `Retrieved ${success} articles`;
            renderFiles();
        }

        window.startFullTextReview = async () => {
            setLoading('start-full-text-review-button', true);
            document.getElementById('full-text-review-panel').classList.remove('hidden');
            cancelOp = false;
            
            const toReview = state.articles.filter(a => (a.Decision === 'INCLUDE' && !a.Override) || a.Override);
            const queue = toReview.map(a => {
                if (a.FullTextFileName && state.uploadedTexts[a.FullTextFileName]) {
                    return { article: a, fullText: state.uploadedTexts[a.FullTextFileName], fileName: a.FullTextFileName };
                }
                const fn = Object.keys(state.uploadedTexts).find(f => f.includes(a.PMID));
                if (fn) return { article: a, fullText: state.uploadedTexts[fn], fileName: fn };
                return null;
            }).filter(x => x);
            
            if (!queue.length) {
                updateStatus('No full texts found', 'error');
                setLoading('start-full-text-review-button', false);
                return;
            }
            
            for (let i = 0; i < queue.length; i++) {
                if (cancelOp) break;
                updateProgress(i + 1, queue.length, 'Reviewing');
                const res = await reviewFullText(queue[i].article, state.criteria, queue[i].fullText);
                const idx = state.articles.findIndex(a => a.PMID === queue[i].article.PMID);
                if (idx !== -1) {
                    state.articles[idx].FinalDecision = res.FinalDecision;
                    state.articles[idx].FinalReasoning = res.FinalReasoning;
                    if (!state.articles[idx].FullTextFileName) state.articles[idx].FullTextFileName = queue[i].fileName;
                }
                await new Promise(r => setTimeout(r, 1000));
            }
            
            updateProgress(0, 0);
            renderFinal();
            if (!cancelOp) {
                updateStatus('Full text review complete', 'success');
                document.getElementById('report-panel').classList.remove('hidden');
                document.getElementById('prisma-panel').classList.remove('hidden');
            }
            setLoading('start-full-text-review-button', false);
        };

        document.getElementById('generate-report-button').addEventListener('click', async () => {
            setLoading('generate-report-button', true);
            const out = document.getElementById('slr-draft-output');
            out.innerHTML = 'Generating...';
            document.getElementById('modification-panel').classList.add('hidden');
            
            const arts = state.articles.filter(a => {
                const fin = a.FinalDecision && a.FinalDecision === 'FINAL_INCLUDE';
                const abs = !a.FinalDecision && ((a.Decision === 'INCLUDE' && !a.Override) || a.Override);
                return fin || abs;
            });
            
            if (!arts.length) {
                out.innerHTML = 'No articles included';
                setLoading('generate-report-button', false);
                return;
            }
            
            const summary = arts.map(a => `PMID: ${a.PMID}\nTitle: ${a.Title}\nAbstract: ${a.Abstract.substring(0, 300)}...\nCategory: ${a.Category}`).join('\n---\n');
            const q = document.getElementById('research-question').value.trim();
            const inst = document.getElementById('drafting-instructions').value.trim();
            
            try {
                updateStatus('Generating report...', 'process');
                const report = await callGemini(
                    'Generate a systematic review draft with inline citations (PMID: X) and a References section.',
                    `Research: ${q}\nArticles: ${arts.length}\n\n${summary}\n\n${inst ? 'Instructions: ' + inst : ''}`
                );
                
                state.currentDraft = report;
                out.innerHTML = report.replace(/^#{1}\s*(.*)$/gm, '<h1>$1</h1>').replace(/^#{2}\s*(.*)$/gm, '<h2>$1</h2>').replace(/^#{3}\s*(.*)$/gm, '<h3>$1</h3>').replace(/\n/g, '<br>');
                document.getElementById('modification-panel').classList.remove('hidden');
                updateStatus('Report generated', 'success');
            } catch (e) {
                updateStatus('Error: ' + e.message, 'error');
            } finally {
                setLoading('generate-report-button', false);
            }
        });

        document.getElementById('refine-report-button').addEventListener('click', async () => {
            setLoading('refine-report-button', true);
            const req = document.getElementById('modification-request').value.trim();
            if (!state.currentDraft || !req) {
                updateStatus('Enter a modification request', 'error');
                setLoading('refine-report-button', false);
                return;
            }
            
            try {
                updateStatus('Refining...', 'process');
                const revised = await callGemini(
                    'Revise this report maintaining citations.',
                    `Draft:\n${state.currentDraft}\n\nRequest: ${req}`
                );
                
                state.currentDraft = revised;
                document.getElementById('slr-draft-output').innerHTML = revised.replace(/^#{1}\s*(.*)$/gm, '<h1>$1</h1>').replace(/^#{2}\s*(.*)$/gm, '<h2>$1</h2>').replace(/^#{3}\s*(.*)$/gm, '<h3>$1</h3>').replace(/\n/g, '<br>');
                updateStatus('Draft refined', 'success');
            } catch (e) {
                updateStatus('Error: ' + e.message, 'error');
            } finally {
                setLoading('refine-report-button', false);
            }
        });

        window.generatePrismaDiagram = () => {
            const out = document.getElementById('prisma-output');
            const total = state.articles.length;
            const incAbs = state.articles.filter(a => (a.Decision === 'INCLUDE' && !a.Override) || a.Override).length;
            const excAbs = state.articles.filter(a => a.Decision === 'EXCLUDE' && !a.Override).length;
            const reviewed = state.articles.filter(a => a.FinalDecision).length;
            const incFinal = state.articles.filter(a => a.FinalDecision === 'FINAL_INCLUDE').length;
            const excFinal = state.articles.filter(a => a.FinalDecision === 'FINAL_EXCLUDE').length;
            const notRev = incAbs - reviewed;
            
            const svg = `
                <svg width="100%" height="700" viewBox="0 0 800 700" xmlns="http://www.w3.org/2000/svg" style="font-family: 'Inter', sans-serif;">
                    <defs><marker id="arrowhead" markerWidth="10" markerHeight="7" refX="0" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="#6b7280" /></marker></defs>
                    <rect x="260" y="30" width="280" height="70" rx="8" fill="#FFF" stroke="#2563EB" stroke-width="2"/>
                    <text x="400" y="58" font-weight="bold" fill="#333" font-size="14" text-anchor="middle">Identification</text>
                    <text x="400" y="78" fill="#555" font-size="12" text-anchor="middle">Records identified (${total})</text>
                    <line x1="400" y1="100" x2="400" y2="150" stroke="#6b7280" stroke-width="2" marker-end="url(#arrowhead)"/>
                    
                    <rect x="260" y="150" width="280" height="70" rx="8" fill="#FFF" stroke="#2563EB" stroke-width="2"/>
                    <text x="400" y="178" font-weight="bold" fill="#333" font-size="14" text-anchor="middle">Screening</text>
                    <text x="400" y="198" fill="#555" font-size="12" text-anchor="middle">Records screened (${total})</text>
                    <line x="400" y1="220" x2="400" y2="270" stroke="#6b7280" stroke-width="2" marker-end="url(#arrowhead)"/>
                    
                    <rect x="580" y="160" width="180" height="50" rx="8" fill="#FEE2E2" stroke="#EF4444" stroke-width="2"/>
                    <text x="670" y="190" fill="#EF4444" font-size="12" text-anchor="middle">Excluded (${excAbs})</text>
                    <line x1="540" y1="185" x2="580" y2="185" stroke="#EF4444" stroke-width="2"/>
                    
                    <rect x="260" y="270" width="280" height="70" rx="8" fill="#FFF" stroke="#9333EA" stroke-width="2"/>
                    <text x="400" y="298" font-weight="bold" fill="#333" font-size="14" text-anchor="middle">Eligibility</text>
                    <text x="400" y="318" fill="#555" font-size="12" text-anchor="middle">Full-text assessed (${incAbs})</text>
                    <line x1="400" y1="340" x2="400" y2="390" stroke="#6b7280" stroke-width="2" marker-end="url(#arrowhead)"/>
                    
                    <rect x="580" y="280" width="180" height="50" rx="8" fill="#FEE2E2" stroke="#EF4444" stroke-width="2"/>
                    <text x="670" y="310" fill="#EF4444" font-size="12" text-anchor="middle">Excluded full-text (${excFinal})</text>
                    <line x1="540" y1="305" x2="580" y2="305" stroke="#EF4444" stroke-width="2"/>
                    
                    <rect x="260" y="390" width="280" height="70" rx="8" fill="#FFF" stroke="#059669" stroke-width="2"/>
                    <text x="400" y="418" font-weight="bold" fill="#333" font-size="14" text-anchor="middle">Included</text>
                    <text x="400" y="438" fill="#555" font-size="12" text-anchor="middle">Studies included (${incFinal})</text>
                </svg>
            `;
            out.innerHTML = svg;
            updateStatus('PRISMA diagram generated', 'success');
        };

        function renderCard(a) {
            const isInc = (a.Decision === 'INCLUDE' && !a.Override) || a.Override;
            const cls = isInc ? (a.Override ? 'bg-yellow-100 text-yellow-800 border-yellow-300' : 'bg-green-100 text-green-800 border-green-300') : 'bg-red-100 text-red-800 border-red-300';
            const status = isInc ? (a.Override ? 'INCLUDED (Override)' : 'INCLUDED (AI)') : (a.Decision === 'EXCLUDE' ? 'EXCLUDED (AI)' : 'ERROR');
            const btn = !isInc && a.Decision === 'EXCLUDE' ? `<button onclick="window.handleOverride('${a.PMID}')" class="mt-4 w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg">Override & Include</button>` : '';
            const pmc = a.PMCID ? `<span class="inline-flex items-center rounded-full bg-purple-100 px-2 py-0.5 text-xs font-medium text-purple-800">PMC ${a.PMCID.replace('PMC', '')}</span>` : '';
            
            return `
                <div class="article-card p-4 rounded-xl border-t-4 ${cls}">
                    <a href="https://pubmed.ncbi.nlm.nih.gov/${a.PMID}/" target="_blank" class="text-lg font-bold text-blue-800 hover:underline block">${a.Title}</a>
                    <div class="flex gap-2 items-center mb-2">
                        <p class="text-xs text-gray-500">PMID: ${a.PMID} | ${a.Category}</p>
                        ${pmc}
                    </div>
                    <div class="my-2 p-2 rounded-lg text-sm font-medium ${cls} border">Status: ${status}</div>
                    <p class="text-sm text-gray-700 font-semibold mt-3">AI Reasoning:</p>
                    <p class="text-sm text-gray-600 italic mb-3">"${a.Reasoning}"</p>
                    <details class="text-xs text-gray-500 cursor-pointer mt-2">
                        <summary>View Abstract</summary>
                        <p class="mt-1 p-2 bg-gray-50 rounded">${a.Abstract}</p>
                    </details>
                    ${btn}
                </div>
            `;
        }

        function renderFinalCard(a) {
            const isInc = a.FinalDecision === 'FINAL_INCLUDE';
            const cls = isInc ? 'bg-purple-100 text-purple-800 border-purple-300' : 'bg-red-100 text-red-800 border-red-300';
            const status = isInc ? 'FINAL INCLUDED' : (a.FinalDecision === 'FINAL_EXCLUDE' ? 'FINAL EXCLUDED' : 'ERROR');
            
            return `
                <div class="article-card p-4 rounded-xl border-t-4 ${cls}">
                    <a href="https://pubmed.ncbi.nlm.nih.gov/${a.PMID}/" target="_blank" class="text-lg font-bold text-blue-800 hover:underline block">${a.Title}</a>
                    <p class="text-xs text-gray-500 mb-2">PMID: ${a.PMID} | Source: ${a.FullTextFileName?.startsWith('AUTO_') ? 'Auto-Retrieved' : 'Manual'}</p>
                    <div class="my-2 p-2 rounded-lg text-sm font-medium ${cls} border">Status: ${status}</div>
                    <p class="text-sm text-gray-700 font-semibold mt-3">Final Reasoning:</p>
                    <p class="text-sm text-gray-600 italic">"${a.FinalReasoning}"</p>
                </div>
            `;
        }

        function renderResults() {
            const inc = state.articles.filter(a => (a.Decision === 'INCLUDE' && !a.Override) || a.Override);
            const exc = state.articles.filter(a => a.Decision === 'EXCLUDE' && !a.Override);
            document.getElementById('included-list').innerHTML = inc.map(renderCard).join('');
            document.getElementById('excluded-list').innerHTML = exc.map(renderCard).join('');
            document.getElementById('included-count').textContent = inc.length;
            document.getElementById('excluded-count').textContent = exc.length;
            document.getElementById('results-panel').classList.remove('hidden');
            
            if (inc.length > 0) {
                document.getElementById('upload-panel').classList.remove('hidden');
                autoRetrieve();
            }
        }

        function renderFinal() {
            const rev = state.articles.filter(a => a.FinalDecision);
            document.getElementById('final-review-list').innerHTML = rev.length ? rev.map(renderFinalCard).join('') : '<p class="text-center text-gray-500 italic">No articles reviewed</p>';
        }

        function renderFiles() {
            const cont = document.getElementById('fileListContainer');
            const msg = document.getElementById('initialMessage');
            const btn = document.getElementById('start-full-text-review-button');
            const files = Object.keys(state.uploadedTexts);
            
            if (!files.length) {
                cont.innerHTML = '';
                msg.style.display = 'block';
                btn.classList.add('hidden');
                return;
            }
            
            cont.innerHTML = '';
            msg.style.display = 'none';
            files.sort((a, b) => (a.startsWith('AUTO_') === b.startsWith('AUTO_')) ? 0 : a.startsWith('AUTO_') ? -1 : 1);
            
            files.forEach(fn => {
                const txt = state.uploadedTexts[fn];
                const isAuto = fn.startsWith('AUTO_');
                const prev = txt.substring(0, 1000) + (txt.length > 1000 ? '...' : '');
                const esc = JSON.stringify(txt);
                
                cont.innerHTML += `
                    <div class="p-4 rounded-xl shadow-md border-l-4 ${isAuto ? 'border-green-500 bg-green-50' : 'border-purple-500 bg-white'}">
                        <div class="flex items-center justify-between mb-3 border-b pb-2">
                            <h3 class="text-lg font-bold text-gray-700 truncate mr-4">${fn}</h3>
                            <span class="text-xs font-semibold ${isAuto ? 'text-green-600' : 'text-purple-600'}">${isAuto ? 'Auto-Retrieved' : 'Manual'}</span>
                        </div>
                        <div class="bg-gray-50 p-3 rounded-lg border">
                            <p class="text-sm font-semibold text-gray-700 mb-1">Preview</p>
                            <pre class="custom-scrollbar text-xs text-gray-800 bg-white p-2 rounded-md overflow-auto max-h-40 whitespace-pre-wrap">${prev}</pre>
                        </div>
                        <button onclick='window.copyText(${esc})' class="mt-3 px-3 py-1 bg-purple-500 text-white text-xs rounded-full hover:bg-purple-600">Copy Full Text</button>
                    </div>
                `;
            });
            
            btn.classList.remove('hidden');
        }

        window.copyText = (txt) => {
            const ta = document.createElement('textarea');
            ta.value = txt;
            document.body.appendChild(ta);
            ta.select();
            document.execCommand('copy');
            document.body.removeChild(ta);
            updateStatus('Copied to clipboard', 'success');
        };

        window.handleOverride = (pmid) => {
            const a = state.articles.find(x => x.PMID === pmid);
            if (a) {
                a.Override = true;
                renderResults();
                updateStatus(`PMID ${pmid} manually included`, 'info');
            }
        };

        window.exportResults = () => {
            const data = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state.articles, null, 2));
            const a = document.createElement('a');
            a.setAttribute("href", data);
            a.setAttribute("download", "slr_results.json");
            document.body.appendChild(a);
            a.click();
            a.remove();
            updateStatus('Results exported', 'info');
        };

        document.getElementById('fileInput').addEventListener('change', () => {
            const files = document.getElementById('fileInput').files;
            if (!files.length) return;
            
            Object.keys(state.uploadedTexts).forEach(k => {
                if (!k.startsWith('AUTO_')) delete state.uploadedTexts[k];
            });
            
            Array.from(files).forEach(f => {
                if (!f.type.startsWith('text/') && !/\.(txt|md|log|csv)$/i.test(f.name)) return;
                
                const r = new FileReader();
                r.onload = e => {
                    state.uploadedTexts[f.name] = e.target.result;
                    renderFiles();
                };
                r.onerror = e => console.error('File read error:', e);
                r.readAsText(f);
            });
        });

        document.getElementById('criteria-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                getKey();
            } catch (err) {
                updateStatus(err.message, 'error');
                return;
            }
            
            const q = document.getElementById('research-question').value.trim();
            const dl = document.getElementById('date-limit').value.trim();
            state.dateLimit = dl ? parseInt(dl) : null;
            
            const result = await generateCriteria(q);
            if (result) {
                document.getElementById('pubmed-query').value = result.SuggestedPubmedQuery || '';
                document.getElementById('inclusion-criteria').value = JSON.stringify({ Inclusion: result.Inclusion, Exclusion: result.Exclusion }, null, 2);
                state.criteria = { Inclusion: result.Inclusion, Exclusion: result.Exclusion };
                state.pubmedQuery = result.SuggestedPubmedQuery;
                document.getElementById('review-panel').classList.remove('hidden');
            }
        });

        document.getElementById('screening-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                getKey();
            } catch (err) {
                updateStatus(err.message, 'error');
                return;
            }
            
            setLoading('start-screening-button', true);
            cancelOp = false;
            state.articles = [];
            state.uploadedTexts = {};
            state.currentDraft = '';
            
            try {
                state.criteria = JSON.parse(document.getElementById('inclusion-criteria').value);
                state.pubmedQuery = document.getElementById('pubmed-query').value;
                
                const uids = await fetchPubMed(state.pubmedQuery, state.dateLimit);
                if (!uids.length) {
                    updateStatus('No articles found', 'info');
                    setLoading('start-screening-button', false);
                    return;
                }
                
                const raw = await fetchAbstracts(uids);
                updateStatus(`Screening ${raw.length} articles...`, 'process');
                
                for (let i = 0; i < raw.length; i += BATCH_SIZE) {
                    if (cancelOp) break;
                    const batch = raw.slice(i, i + BATCH_SIZE);
                    updateProgress(i + batch.length, raw.length, 'Screening');
                    const results = await Promise.all(batch.map(a => screenArticle(a, state.criteria).then(r => ({ ...a, ...r }))));
                    state.articles.push(...results);
                    await new Promise(r => setTimeout(r, 500));
                }
                
                updateProgress(0, 0);
                if (!cancelOp) {
                    renderResults();
                    updateStatus(`Screening complete! ${state.articles.length} articles reviewed`, 'success');
                }
            } catch (err) {
                updateStatus('Error: ' + err.message, 'error');
            } finally {
                setLoading('start-screening-button', false);
            }
        });

        document.getElementById('cancel-btn').addEventListener('click', () => {
            cancelOp = true;
            updateStatus('Cancelling...', 'info');
            document.getElementById('cancel-btn').classList.add('hidden');
        });

        updateStatus('Enter your API key and research question to start', 'info');
    </script>
</body>
</html>